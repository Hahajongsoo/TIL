# 데이터 링크 계층의 역할과 기능

## 데이터 링크 계층이란?
- OSI 7 Layer의 2계층으로 인접한 네트워크 노드끼리 데이터를 전송하는 기능과 절차를 제공
- 물리계층에서 발생할 수 있는 오류를 감지하고 수정
- 대표적인 프로토콜로 이더넷이 있으며 장비로는 스위치가 있다.
- PDU는 Frame이고 Layer 3에서는 Packet이 된다.

### 2개의 부 계층
- MAC(media Access Control)
	- 물리적인 부분으로 매체간의 연결방식을 제어하고 1계층과 연결 
	- 통신하는 장비들이 가지고 있는 물리적인 네트워크 인터페이스
- LLC(Logical Link Control)
	- 논리적인 부분으로 Frame을 만들고 3계층과 연결
![](images/Pasted%20image%2020221114161401.png)
- 데이터링크 계층은 MAC과 LLC로 이루어져 있으며 Frame 단위로 전송을 하고 상위 계층은 Packet으로 전송을한다.

### MAC 주소
- 터미널에서 명령어로 확인할 수 있다. (ipconfig, ifconfig)
- 물리적 주소, ether
![](images/Pasted%20image%2020221114162204.png)
- 48bit (6byte)로 6자리로 구성, 각 16진수로 표현
- 앞에 3자리는 OUI(Organization Unique Identifier)로 제조사 식별 코드를 의미한다. 벤더들의 번호를 의미한다.
- 나머지 3자리는 제조사 내 일련번호를 의미한다.

## 주요 기능

### Framing
- 데이터그램(패킷)을 캡슐화하여 프레임 단위로 만들고 헤더와 트레일러를 추가
- 헤더는 목적지, 출발지 주소 그리고 데이터 내용을 정의
	- 데이터링크에서 어떤 디바이스로 통신하는지 알 수 있다.
- 트레일러는 비트 에러를 감지
![](images/Pasted%20image%2020221114162449.png)
- 비트를 프레임으로 만드는 것도 프레이밍이다.

### 회선 제어
- 회선은 장치와 장치간 연된 통신 경로로 회선 제어는 신호간의 충돌이 발생하지 않도록 제어하는 것을 의미한다.
- ENQ/ACK 방법
	- 장비와 장비가 1:1로 연결되어 있을 때 사용하는 방법, 전용 전송 링크 1:1
	- ENQ프레임을 보내서 데이터 받을 수 있는지 확인, ACK로 데이터 받을 수 있음을 알림, Data 보냄, Data 받았다고 ACK를 보냄, EOT로 프로세스 종료 
![](images/Pasted%20image%2020221114162729.png)
- Polling 방법 
	- 1 : 다
	- Select 모드: 송신자가 나머지 수신자들을 선택해서 전송
		- PC1에서 SEL 프레임을 보내서 PC2와 PC3 선택, ACK로 데이터 받을 수 있음을 알림
	- Poll 모드: 수신자에게 데이터 수신 여부를 확인하여 응답을 확인하고 전송 - multipoint
		- PC2는 데이터를 받지 않는다는 NAK 프레임을 전송, PC3는 ACK을 전송, PC1은 PC3에 데이터를 전송
	![](images/Pasted%20image%2020221114163012.png)

### 흐름 제어
- 송신자와 수신자의 데이터를 처리하는 속도 차이를 해결하기 위한 제어
- Feedback 방식의 Flow Control이며 상위 계층의 Rate 기반
- PC1은 1Gbps, PC2는 10Mbps 인 경우 1이 2에게 1Gbps로 데이터를 보내게 되면 2는 해당 데이터를 처리할 수 없다. 이러한 속도 차이를 맞춰줘야한다. 

#### 방식
##### Stop & Wait
![](images/Pasted%20image%2020221114163642.png)
- Frame을 전달하고 ACK이 회선 문제로 응답하지 않는 경우
	- 패킷이 사라지는 경우도 있다.
![](images/Pasted%20image%2020221114163819.png)
- Frame 을 재전송하게 되면 Duplicate frame 문제가 발생될 수 있음
- Sequence number(1bit)를 사용하여 동일 frame인지 구분하여 상위 계층으로 전달
![](images/Pasted%20image%2020221114164111.png)

##### Siding window
- ACK 응답 없이 여러 개의 프레임이 연속으로 전송 가능
- Window size는 전송과 수신측의 데이터가 저장되는 버퍼의 크기
	- 버퍼만큼 주고받고 해당 크기보다 큰 경우 문제가 발생할 수 있다.
![](images/Pasted%20image%2020221114164313.png)
- 회선 속도가 빨라지면 더 많은 양을 보내고 회선 속도가 느려지면 더 적은 양을 보내는 방식

### 오류 제어
- 전송 중에 오류나 손실 발생 시 수신측은 에러를 탐지 및 재전송
- ARQ(Automatic Repeat Request): 프레임 손상 시 재전송이 수행되는 과정

#### Stop & Wait ARQ
![](images/Pasted%20image%2020221114164725.png)

#### Go Back n ARQ
![](images/Pasted%20image%2020221114164821.png)
- 하나의 묶음이기 때문에 Frame 345를 폐기해야한다.

#### Selective Repeat ARQ
- Go Back n ARQ에서 묶음을 다시 재전송하는 방식의 비효율성이 문제
- 손상된 Frame만 선별해서 재전송한다.

## 이더넷 프레임 구조

### Ethernet v2
- 데이터 링크 계층에서 MAC(media access contral) 통신과 프로토콜의 형식을 정의
![](images/Pasted%20image%2020221114165201.png)
- Preamble: 이더넷 프레임의 시작과 동기화, 이더넷 프레임에 포함이 안되어있다고 봐도 된다.
- Dest Addr: 목적지 MAC 주소, Src Addr: 출발지 MAC 주소
- Type: 캡슐화 되어있는 패킷의 프로토콜 정의, 상위계층의 프로토콜(e.g. IPv4)
- Data: 상위 계층의 데이터로 46 ~ 1500바이트의 크기, 46바이트보다 작으면 뒤에 패딩이 붙는다.
- FCS(Frame Check Sequence): 에러 체크

# 스위치과 ARP

##  스위치
- 2계층의 대표적인 장비로 MAC주소 기반 통신
- 허브의 단점을 보완함
	- Half duplex를 Full duplex로 보완
	- 1 Collision Domain의 포트별 Collision Domain으로 보완
		- 해당 되는 도메인에 대해서만 통신을 하고 불필요한 패킷은 보내지 않는다.
- 라우팅 기능이 있는 스위치를 L3 스위치라고도 부른다. 

#### 동작방식
- 목적지 주소를 MAC 주소 테이블에서 확인하여 연결된 포트로 프레임 전달
1. Learning:  출발지 주소가 MAC 주소 테이블에 없으면 해당 주소를 저장, 스위치에 연결되어있는 컴퓨터나 서버들의 정보를 수집
2. Flooding - Broadcasting : 목적지 주소가 MAC 주소 테이블에 없으면 가지고 있는 포트 전체에 전달
3. Forwarding : 목적지 주소가 MAC 주소 테이블에 있으면 해당 포트로 전달
4. Filtering - Collision Domain : 여러개 collision domain이 있고 collision domain 끼리 통신하지 못하게 한다. 출발지와 목적지가 같은 네트워크 영역이면 다른 네트워크로 전달하지 않음
5. Aging : MAC 주소 테이블의 각 주소는 일정 시간 이후에 삭제

##### Learning
![](images/Pasted%20image%2020221114171812.png)
- 4개의 PC는 스위치에 각 포트에 연결되고 프레임이 스위치에 전달된다.
- 스위치는 해당 포트로 유입된 프레임을 보고 MAC 주소를 테이블에 저장한다.

##### Flooding
![](images/Pasted%20image%2020221114171935.png)
- PC1은 목적지 aa:bb:cc:dd:ee:05 주소로 프레임 전달
- 스위치는 해당 주소가 MAC Table에 없어서 전체 포트로 전달

##### Forwarding
![](images/Pasted%20image%2020221114172035.png)
- PC1은 목적지 aa:bb:cc:dd:ee:05 주소로 프레임 전달
- 스위치는 해당 주소가 MAC Table에 있으므로 해당 프레임을 PC5에 전달

##### Filtering
![](images/Pasted%20image%2020221114172158.png)
- PC1은 목적지 aa:bb:cc:dd:ee:02 주소로 프레임 전달
- 스위치는 해당 주소가 동일 네트워크 영역임을 확인하여 다른 포트로 전달하지 않음
- 필터링은 각 포트별 Collision Domain을 나누어 효율적 통신이 가능하다.

##### Aging
- 스위치의 MAC 주소 테이블은 시간이 지나면 삭제
- 삭제되는 이유는 테이블 저장 공간을 효율적으로 사용하기 위해서이다.
- 해당 포트에 연결된 PC가 다른 포트로 옮겨지는 경우도 발생한다. 동일한 MAC 주소가 하나의 스위치에 있게 되므로 네트워크의 충돌이 일어나고 네트워크가 죽어버린다.
- 기본 300초 (Cisco 기준) 저장, 다시 프레임이 발생되면 다시 카운트

### 정리
1.  프레임 유입
	- 신규 주소면 출발지 주소 저장(Learning)
	- 기존 주소면 Aging 타이머 재시작
2. 정보 전송
	- 목적지를 모르면 Flooding
	- 목적지가 MAC Table에 존재하면 Forwarding
	- 목적지가 출발지와 같은 포트에 존재하면 Filtering

## ARP
- Address Resolution Protocol
- IP주소를 통해서 MAC 주소를 알려주는 프로토콜
- 컴퓨터 A가 컴퓨터 B에게 IP통신을 시도하고 통신을 수행하기 위해 목적지 MAC 주소를 알아야한다.
- 목적지 IP에 해당되는 MAC 주소를 알려주는 역할을 ARP가 해준다.
![](images/Pasted%20image%2020221114173002.png)

### 동작 과정
![](images/Pasted%20image%2020221114173452.png)
1. PC1은 동일 네트워크 대역인 목적지 IP 172.20.10.9로 패킷 전송을 시도, 목적지 MAC 주소를 알기 위해서 우선 자신의 ARP Cache Table을 확인
![](images/Pasted%20image%2020221114174242.png)
2. ARP Cach Table에 있으면 패킷 전송, 없으면 ARP Request 전송 - Broadcasting
![](images/Pasted%20image%2020221114174124.png)
3. IP 172.20.10.9에서 목적지 MAC 주소를 ARP Reply로 전달
![](images/Pasted%20image%2020221114174153.png)
4. 목적지 MAC주소는 ARP Cache Table에 저장되고 패킷 전송
![](images/Pasted%20image%2020221114174211.png)

### ARP 헤더 구조
![](images/Pasted%20image%2020221114174335.png)
- Hardware Type: ARP가 동작하는 네트워크 환경, 이더넷
- Protocol Type: 프로토콜 종류, 대부분 IPv4
- Hardware $ Protocol Length: MAC 주소 6Byte, IP주소 4Byte
- Operation: 명령코드, 1=ARP Request, 2=ARP Reply
- Hardware Address=MAC, Protocol Address=IP
![](images/Pasted%20image%2020221114174632.png)


