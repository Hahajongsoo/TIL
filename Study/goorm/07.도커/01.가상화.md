# 가상화
## 가상화 배경
- 가상화가 주목받기 시작한 이유는 하드웨어 기술의 성장과 보급 증가로 성능이 우수한 하드웨어를 구하기 쉬워졌기 때문이다.
- 이로 인해 시스템의 리소스 활용률은 낮아졌고, 활용하지 않는 자원을 사용하려는 기술들이 개발되어 현재의 가상화를 이루고 있다.

## 가상화 종류
- 서버 가상화
- 네트워크 가상화
- 스토리지 가상화
- 컨테이너 가상화

## 서버 가상화
- 서버 가상화는 가장 일반적인 가상화이며, 가상 머신을 생성할 때 사용하는 기술
- 가상 머신을 생성하려면 CPU나 메모리와 같은 시스템 자원을 나눠주는 파티셔닝 기술이 필요하다.
- 파티셔닝 기술은 하드웨어 파티셔닝과 소프트웨어 파티셔닝이 있지만, 현재 소프트웨어 파티셔닝 을 주로 사용하고 하이퍼바이저가 소프트웨어 파티셔닝을 해준다. 
- 다른 게스트 OS를 움직이고 있기 때문에 오버헤드가 커진다. 오버헤드란 가상화를 수행하기 위해 필요한 CPU자원, 디스크 용량, 메모리 사용량 등을 의미한다.
 
### 하이퍼바이저
- 호스트가 소프트웨어 파티셔닝을 할 수 있게 만들어주는 소프트웨어
- 하이퍼바이저의 역할은 가상 머신의 리소스 관리 뿐만 아니라 서로 독립적인 환경을 사용할 수 있도록 리소스간 접근 방지 기능도 가지고 있다.
- 하이퍼바이저는 가상 머신이 어느정도의 가상 리소스를 할당 받을지를 정하고 실제 물리적인 자원을 사용할 수 있도록 리소스를 관리한다. 

### 네트워크 가상화
- 가상으로 네트워크 인터페이스를 생성하고 가상으로 네트워크를 구축하는 것 
- VPC, VLAN 등

# 컨테이너 가상화
컨테이너를 사용할 수 있는 운영체제는 리눅스 또는 유닉스만 가능하다. 컨테이너의 기능을 제공하는 것이 리눅스 커널의 기본 기능
## 리눅스 컨테이너
- 리눅스 컨테이너는 컨테이너 가상화 기술을 사용한다.
- 리눅스 컨테이너에는 애플리케이션이나 이에 필요한 라이브러리 및 설정 파일등이 포함된다
- 리눅스 컨테이너는 오래전부터 사용되었지만 극히 일부 기업에서만 사용되었지만 이후에 도커가 사용되면서 활발하게 사용되고 있다. 
### 리눅스 컨테이너에서 사용하는 기술
#### cgroup
- 프로세스 또는 쓰레드를 그룹화하여 관리하는 기능과 시스템 리소스등의 사용을 제한하는 기술
- 리눅스 컨테이너는 호스트의 리소스를 공유하여 사용하는데, 이때 cgroup을 사용하여 컨테이너가 사용하는 리소스의 양을 제한할 수 있다.
#### namespace
- namespace에 다수의 오브젝트를 격리할 수 있다.
- 동일한 호스트에서 동일한 PID를 가질 수 없지만 서로 다른 namespace에서는 동일한 PID를 가질 수 있다.
- namespace의 종류에는 PID, Network, UID, Mount, UTS, IPC namespace가 있다. 

# 도커
## 도커
- 도커를 사용하면 리눅스 컨테이너를 더 쉽게 관리하고 실행할 수 있다.
- 도커의 가장 큰 특징은 이식성인데, 이는 개발환경, 테스트환경 서비스환경을 모두 동일하게 사용할 수 있기 때문이다. 

### 도커를 사용하는 이유
- 서버를 코드 형태로 정의
	- 도커는 이미지를 사용하여 컨테이너를 실행한다.
	- 컨테이너는 하나의 애플리케이션을 실행하는 서버처럼 동작한다.
	- 도커는 이미지를 제작할 때 코드 형태로 정의하여 작성 가능
	- 서버를 코드 형태로 정의할 수 있어 일관성을 유지하는 것과 버전관리 부분에서도 편리하다.
- 이식성
	- 애플리케이션 개발 단계는 크게 개발 단계, 테스트 단계, 서비스 단계로 나뉜다.
	- 각 단게의 환경을 통일하기는 쉽지않지만 도커를 사용하면 컨테이너에 모든 환경을 구축하기 때문에 도커만 설치하면 된다.
- 상호 운용성
	- 도커는 Google, Amazon, IBM, MS, Red Hat 등 다양한 벤더에서 지원하기 때문에 다양한 벤더의 시스템 및 오픈 소스와 연계하여 사용할 수 있다.

## 도커의 구조
### 이미지
- 도커로 컨테이너를 생성하려면 미리 제작된 이미지가 있어야 한다.
- 이미지는 여러 개의 레이어로 이루어져 있으며, 각 레이어는 Read Only 상태로 사용된다.
- 이미지로 컨테이너를 실행하여 파일을 생성하거나 삭제한다면 새로운 레이어를 만들어 내용을 저장하는데 이 때 사용하는 방식이 Copy On Write와 유사하다.
### 저장소
- 컨테이너를 생성하려면 이미지가 있어야하고, 이미지는 호스트가 아닌 외부에 저장되어 공유할 수 있어야 한다.
- 이를 저장소라고 하며, 범위에 따라 퍼블릭 이미지 저장소와 프라이빗 이미지 저장소로 나눌 수 있다.
### 컨테이너
- 컨테이너는 이미지의 실행 형태이다.
- 이미지가 메모리에 올라가면 컨테이너, 컨테이너가 디스크에 저장되어 있으면 이미지이다.
- 하나의 컨테이너에는 하나의 애플리케이션만 실행되는 것이 권장되며, 추가로 실행할 수 있지만 유지하는 것은 권장하지 않는다.

## 도커의 기능
### 이미지 생성
- 도커는 다양한 방법으로 이미지를 생성할 수 있다.
- 가장 대표적이며 일반적으로 사용하는 것이 DockerFile이며, 그 밖에 컨테이너를 이미지로 생성하는 docker commit 명령과 컨테이너의 파일 시스템으로 이미지를 생성하는 docker export와 docker import 명령이 있다.
### 이미지 공유
- 도커는 저장소를 사용하여 이미지를 공유함
- 저장소는 도커 허브 뿐만 아니라 다른 프라이빗 이미지 저장소도 사용할 수 있다.
### 컨테이너 생성
- 도커는 컨테이너를 생성하고 관리할 수 있는 컨테이너 런타임이다.
- 컨테이너를 생성하고 네트워크 또는 볼륨과 같은 도커 오브젝트를 생성한 뒤 컨테이너에 연결하여 사용할 수도 있다.

- `/var/lib/docker/image/overlay2/layerdb/` 도커 이미지 레이어들이 저장된다. 

```
[root@docker ~]# ls /var/lib/docker/image/overlay2/layerdb/sha256/
e07ee1baac5fae6a26f30cabfe54a36d3402f96afda318fe0a96cec4ca393359

```