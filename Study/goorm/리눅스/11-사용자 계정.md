# 사용자 계정 관련 파일
## 사용자 관리
- 리눅스는 다중 사용자 시스템이므로 사용자를 구별하고 사용자에게 적절한 자원을 할당해주는 방법이 필요하다.
- 사용자 계정은 사용자가 시스템에 접근할 수 있는 유일한 방법이다. 사용자가 없으면 시스템에 로그인 할 수 없기 때문에 시스템을 사용할 수도, 시스템을 관리할 수도 없다. 
- 시스템 관리자의 입장에서도 사용자의 접근 권한을 통제할 수 있는 중요한 수단이다. 
- 실무에서 root 계정은 로그인을 막고 사용자마다 계정을 부여한다.

## `/etc/passwd`
- 사용자 계정 정보가 저장된 기본  파일
- 한 행에 사용자 한 명에 대한 정보가 기록되며, `:`으로 구분되는 일곱 개의 항목 구성
```
[root@localhost ~]#cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
...
vboxadd:x:988:1::/var/run/vboxadd:/bin/false
user1:x:1001:1001::/home/user1:/bin/bash
apache:x:48:48:Apache:/usr/share/httpd:/sbin/nologin
```
1. 로그인 ID: 사용자 계정의 이름, 32자를 넘을 수 없으나 8자로 제한하는 것이 좋다.
2. x: 초기 유닉스 시스템에서 사용자 암호를 저장하던 항목, 요즘은 `/etc/shadow` 파일에 별도로 보관한다. x값이 없으면 패스워드 없는 것으로 간주된다.
3. UID: 사용자 ID 번호로 시스템이 사용자를 구별하기 위해 사용하는 번호
	- 0~999 번과 65534번은 시스템 사용자를 위한 UID로 예약되어 있다. (0:root, 1:bin, 2:deamon 등)
	- 일반 사용자들은 UID 1000번 부터 할당
	- 로그인 ID가 다르더라도 UID가 같으면 리눅스 시스템은 같은 사용자로 판단한다. 따라서 UID가 중복되지 않았는지 주의해야한다.
4. GID: 그룹 ID, 시스템에 등록된 그룹에 대한 정보는 `/etc/group` 파일에 저장된다.
5. 설명: 사용자의 실명이나 부서명, 연락처 등 사용자에 대한 일반적인 정보가 기록된다.
6. 홈 디렉토리: 사용자 계정에 할당된 홈 디렉토리의 절대 경로를 기록한다.
7. 로그인 셸: 사용자의 로그인 셸을 지정한다. 

## `/etc/shadow`
- 사용자의 패스워드를 해시패스워드 형태로 저장하고 패스워드에 대한 속성을 저장한 파일이다.
- 관리자 이외의 사용자에 대한 접근이 차단된다. root 계정만 볼 수 있다.
```
[root@localhost ~]#ll /etc/shadow
----------. 1 root root 1412 Jan  4 15:34 /etc/shadow
[root@localhost ~]#cat /etc/shadow
root:$6$6mQNk9FLRr4Od/lU$WXwgMmEotdqUDOpQd6ccNZYdabnx5k7PqL7b0nxdFpCUtGpBRuicfi9eqU4UdYv./GN9KxsKB8F185Ydjnu5M0::0:99999:7:::
bin:*:18353:0:99999:7:::
daemon:*:18353:0:99999:7:::
adm:*:18353:0:99999:7:::
lp:*:18353:0:99999:7:::
sync:*:18353:0:99999:7:::
shutdown:*:18353:0:99999:7:::
halt:*:18353:0:99999:7:::
mail:*:18353:0:99999:7:::
...
```
1. USER: 사용자 계정 이름
2. HASH: 실제 비밀번호가 암호화되어 저장된다. $로 구분되며 3개로 나뉜다. 첫 번째 필드는 해시 알고리즘, 두 번째 필드는 salt, 세 번째 필드는 비밀번호 이다. salt는 기존 패스워드에 임의 문자열을 덧붙이는 것이다. 
3. LASTCHANGE: 암호가 마지막으로 변경된 날짜 지정한다. 1970년 1월 1일을 기준으로 날 수를 기록
4. MIN: 암호를 변경한 후 사용해야 하는 최소 기간
5. MAX: 암호 변경후 사용할 수 있는 최대 기간
6. WARNING: 암호가 만료되기 전에 경고를 시작하는 날 수
7. INACTIVE: 암호가 만료된 후에도 이 항목에 지정한 날 수 동안은 로그인이 가능, 해당 기간 안에 암호를 변경하지 않으면 계정이 잠금 상태가 된다.
8. EXPIRE: 사용자 계정이 만료되는 날
9. Flag: 향후 사용할 목적으로 비워둔 항목

## `/etc/login.defs`
- 사용자 계정의 설정과 관련된 기본 값을 정의
```
[root@localhost ~]#cat /etc/login.defs
#
# Please note that the parameters in this configuration file control the
# behavior of the tools from the shadow-utils component. None of these
# tools uses the PAM mechanism, and the utilities that use PAM (such as the
# passwd command) should therefore be configured elsewhere. Refer to
# /etc/pam.d/system-auth for more information.
#

# *REQUIRED*
#   Directory where mailboxes reside, _or_ name of file, relative to the
#   home directory.  If you _do_ define both, MAIL_DIR takes precedence.
#   QMAIL_DIR is for Qmail
#
#QMAIL_DIR	Maildir
MAIL_DIR	/var/spool/mail
#MAIL_FILE	.mail

# Password aging controls:
#
#	PASS_MAX_DAYS	Maximum number of days a password may be used.
#	PASS_MIN_DAYS	Minimum number of days allowed between password changes.
#	PASS_MIN_LEN	Minimum acceptable password length.
#	PASS_WARN_AGE	Number of days warning given before a password expires.
#
PASS_MAX_DAYS	99999
PASS_MIN_DAYS	0
PASS_MIN_LEN	5
PASS_WARN_AGE	7

#
# Min/max values for automatic uid selection in useradd
#
UID_MIN                  1000
UID_MAX                 60000
# System accounts
SYS_UID_MIN               201
SYS_UID_MAX               999

#
# Min/max values for automatic gid selection in groupadd
#
GID_MIN                  1000
GID_MAX                 60000
# System accounts
SYS_GID_MIN               201
SYS_GID_MAX               999

#
# If defined, this command is run when removing a user.
# It should remove any at/cron/print jobs etc. owned by
# the user to be removed (passed as the first argument).
#
#USERDEL_CMD	/usr/sbin/userdel_local

#
# If useradd should create home directories for users by default
# On RH systems, we do. This option is overridden with the -m flag on
# useradd command line.
#
CREATE_HOME	yes

# The permission mask is initialized to this value. If not specified, 
# the permission mask will be initialized to 022.
UMASK           077

# This enables userdel to remove user groups if no members exist.
#
USERGROUPS_ENAB yes

# Use SHA512 to encrypt password.
ENCRYPT_METHOD SHA512
```
- 기본 메일 디렉토리, 패스워드 기간 관련, 패스워드 최소 길이, 사용자 계정과 시스템 계정의 UID, GID 범위, 홈 디렉터리 생성 여부, umask 값, 사용자 계정 삭제 시 그룹 삭제 여부, 암호화 기법 등의 내용을 정할 수 있다.
	- umask는 홈 디렉토리에 관여하는 umask 값이다. 

## `/etc/group`
- 그룹에 대한 정보를 저장한다. 대부분의 리눅스에서는 사용자가 생성되면 그 사용자의 이름 과 똑같은 이름의 그룹도 함께 생성된다.
- `/etc/passwd` 파일의 GID 항목에 지정된 그룹이 기본 그룹이며 사용자가 속한 2차 그룹은 `/etc/group` 파일에 지정된다.
```
[root@localhost ~]#cat /etc/group
root:x:0:
bin:x:1:
daemon:x:2:
sys:x:3:
adm:x:4:
tty:x:5:
disk:x:6:
lp:x:7:
mem:x:8:
kmem:x:9:
wheel:x:10:user
cdrom:x:11:
mail:x:12:postfix
...
```
1. GROUP: 그룹의 이름
2. x: 그룹의 패스워드, `/etc/gshadow` 파일에 저장된다.
3. GID: 그룹의 GID
4. MEMBER: 이 그룹을 보조 그룹으로 지정하고 있는 사용자의 목록

## `/etc/gshadow`
- 그룹의 암호가 저장되는 파일이다.
- 원래 유닉스에는 없는 파일이며 그룹의 해시 패스워드는 잘 사용되지 않는다.
```
[root@localhost ~]#cat /etc/gshadow
root:::
bin:::
daemon:::
sys:::
...
```
1. 그룹 이름
2. 그룹 패스워드
3. 관리자
4. 그룹 멤버

# 사용자 계정 관리 명령

## 사용자 계정 생성하기: `useradd`
- 형식: `useradd [옵션] [로그인 ID]`
- 옵션
	- `-u uid` : UID를 지정한다.
	- `-o`: UID의 중복을 허용한다.
	- `-g gid`: 기본 그룹의 GID를 지정한다.
	- `-G gid`: 보조 그룹의 GID를 지정한다.
	- `-d 디렉토리 명`: 홈 디렉토리를 지정한다.
	- `-s 셸`: 기본 셸을 지정한다.
	- `-c 설명`: 주석 추가
	- `-D`: 기본값을 설정하거나 출력한다.
	- `-e 유효기간`: EXPIRE 항목을 설정한다.
	- `-f 비활성 일수`: INACTIVE 항목을 설정한다.
	- `-k 디렉토리`: 계정 생성시 복사할 초기 파일이나 디렉토리를 설정해놓은 디렉토리를 지정한다. 
	- `-m`: 사용자의 홈 디렉토리가 존재하지 않을 경우 생성한다. `/etc/login.defs` 파일의 CREATE_HOME 이 yes로 되어있지 않다면 홈디렉토리가 생성되지 않으므로 이 옵션을 사용하면 된다.

### 옵션 없이 계정 생성
```
[root@localhost ~]#useradd user1
[root@localhost ~]#passwd user1
Changing password for user user1.
New password: 
BAD PASSWORD: The password is a palindrome
Retype new password: 
passwd: all authentication tokens updated successfully.
[root@localhost ~]#tail /etc/passwd
apache:x:48:48:Apache:/usr/share/httpd:/sbin/nologin
user1:x:1001:1001::/home/user1:/bin/bash
[root@localhost ~]#tail /etc/shadow
apache:!!:19361::::::
user1:$6$YtGjSS7x$DR8/ElQmL8A7QkKDA4n5Wjp4ieEQFI7nVPZeURsFRexV4HT6V4mD3kDwDsE/J.LQxM694gsLmLAt2A1SBDFg./:19362:0:99999:7:::
```

### 기본 설정 값 확인
```
[root@localhost ~]#useradd -D
GROUP=100
HOME=/home
INACTIVE=-1
EXPIRE=
SHELL=/bin/bash
SKEL=/etc/skel
CREATE_MAIL_SPOOL=yes
```
- GROUP: 기본 등록 그룹의 GID로 100은 users 그룹이다.
- HOME: 홈 디렉토리의 생성위치
- INACTIVE: -1이면 비활성화된다. 0이면 암호가 만료되자마자 바로 계정이 잠긴다.
- EXPIRE: 계정 종료일을 지정한다.
- SHELL: 기본 로그인 셸을 지정한다.
- SKEL: 홈 디렉토리에 복사할 기본 환경 파일의 위치이다.
- CREATE_MAIL_SPOOL: 메일 디렉토리의 생성 여부를 지정한다. 

`/etc/login.defs` 와 `/etc/default/useradd` 두 개의 파일에 기본 값이 설정되어 있다. 기본 값을 설정하려면 두 파일 모두 수정해줘야한다. 수정을 할 때 파일을 수정하기 보다는 `useradd -D` 명령어를 통해서 수정하는 것이 좋다. 

| 옵션        | 설정                                                            |
| ----------- | --------------------------------------------------------------- |
| -b 디렉토리 | 사용자 생성시 기본 홈 디렉토리를 설정한다.                      |
| -e 만기일   | 사용자 생성시 `/etc/shadow` 파일의 EXPIRE 필드 값을 지정한다.   |
| -f 기간     | 사용자 생성시 `/etc/shadow` 파일의 INACTIVE 필드 값을 지정한다. |
| -g GID      | 사용자 생성시 기본 그룹의 GID를 지정한다.                       |
| -s 셸       | 사용자의 기본 셸을 지정한다.                                    | 

#### `/etc/skel` 디렉토리의 역할
- 사용자 계정의 홈 디렉토리에 공통으로 배포해야 할 파일을 `/etc/skel` 디렉토리에 파일을 만들어 놓으면 상요자 계정 생성시에 자동으로 복사한다.
```
[root@localhost ~]#ls -al /etc/skel
total 24
drwxr-xr-x.   3 root root   78 Jan  5 15:50 .
drwxr-xr-x. 140 root root 8192 Jan  5 16:07 ..
-rw-r--r--.   1 root root   18 Apr  1  2020 .bash_logout
-rw-r--r--.   1 root root  193 Apr  1  2020 .bash_profile
-rw-r--r--.   1 root root  231 Apr  1  2020 .bashrc
drwxr-xr-x.   4 root root   39 Sep 12  2021 .mozilla
```

## 사용자 계정 삭제하기: `userdel`
- 형식: `userdel [옵션] [계정명]`
- 옵션:
	- `-r`: 홈 디렉토리를 삭제한다.
	- `-f`: 사용자가 로그인 중이어도 강제로 삭제한다.
- 사용자 계정이 삭제될 때 홈 디렉토리나 소유한 파일을 모두 삭제하는 것이 바람직하다.
- `-r` 옵션으로 홈 디렉토리와 함께 삭제하고 `find / -user UID -exec rm -r {} \;` 명령으로 홈 디렉토리가 아닌 위치에 존재하는 모든 파일 삭제