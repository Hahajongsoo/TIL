# 변수
## Ansible의 변수 사용
- Ansible을 이용하여 시스템의 구성 관리를 자동화 할 수 있지만, 모든 시스템이 항상 같은 구성을 가지지 않고 경우에 따라 다른 구성을 가져야할 수 있음
- ansible은 변수를 사용해 시스템 간 차이를 처리

## 변수명
- 변수 이름에는 문자, 숫자, `_` 만 포함
- 이미 예약된 플레이북 키워드나 Python 키워드는 사용할 수 없다.
- 변수는 숫자로 시작할 수 없다.

## 변수 정의 및 참조
### 기본 변수
- 변수 선언시 key: value 의 형태로 선언
```
$ cat test4.yaml 
- name: vars test
  hosts: ansi-node1
  vars:
    var1: abc
    var2: 123
  tasks:
    - name: print vars
      debug:
        msg: "var1: {{ var1 }} \n var2: {{ var2 }}"
    - name: var location test
      debug:
        msg: var1:{{ var1 }}
```
- 변수 참조
	- 변수를 참조할 때는 반드시 이중 중괄호를 사용
	- 변수가 참조하는 사전의 모든 값을 따옴표로 인용
	- 참조 변수가 뒤에 오는 경우에는 생략 가능
```yaml
- name: vars test
  hosts: ansi-node1
  vars:
    var1: abc
    var2: 123
  tasks:
    - name: print vars
      debug:
        msg: "var1: {{ var1 }} \n var2: {{ var2 }}"
    - name: var location test
      debug:
        msg: var1:{{ var1 }}
```

### 목록 변수
- 여러 개의 값이 목록으로 선언된 변수
- 변수 참조시 인덱싱을 이용
```
$ cat test4.yaml 
- name: vars test
  hosts: ansi-node1
  vars:
    list_var:
      - abc
      - 123
  tasks:
    - name: print vars
      debug:
        msg: "list_var[0]: {{ list_var[0] }} \n list_var[1]: {{ list_var[1] }}"
```

```
$ ansible-playbook test4.yaml

PLAY [vars test] ****************************************************************************************

TASK [Gathering Facts] ***********************************************************************************
ok: [ansi-node1]

TASK [print vars] ****************************************************************************************
ok: [ansi-node1] => {
    "msg": "list_var[0]: abc \n list_var[1]: 123"
}

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 
```

### 사전 변수
- 하나 이상의 사전 값이 선언된 변수
- 참조 시 키값을 이용, 대괄포 표기법이나 점 표기법 사용
	- 모듈에 따라 일부 키가 Python 사전의 속성 및 메서드와 충돌할 수 있다.
```
$ cat test4.yaml 
- name: vars test
  hosts: ansi-node1
  vars:
    dict_var:
      str: abc
      num: 123
  tasks:
    - name: print vars
      debug:
        msg: "dict_var.str: {{ dict_var.str }} \n dict_var['num']: {{ dict_var['num'] }}"
```

```
$ ansible-playbook test4.yaml

PLAY [vars test] ****************************************************************************************

TASK [Gathering Facts] ***********************************************************************************
ok: [ansi-node1]

TASK [print vars] ****************************************************************************************
ok: [ansi-node1] => {
    "msg": "dict_var.str: abc \n dict_var['num']: 123"
}

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 
```

### 등록 변수
- 등록 변수는 모듈의 반환 값을 저장하는 변수이다.
- Ad-hoc 명령에서 모듈을 실행 시 작업의 결과로 모듈의 반환 값이 출력된다.
- 모듈에 따라 반환 값은 다르다.
- 플레이북 실행 시 별도로 모듈의 반환 값이 출력되지 않는데, 등록 변수를 이용해 확인할 수 있다.
```
$ cat test4.yaml 
- name: register vars
  hosts: ansi-node1
  gather_facts: no
  tasks:
    - name: Input register vars
      command: "ls -al /home/vagrant"
      register: result
    - name: Output register vars
      debug:
        msg: "{{ result.stdout_lines }}"
```

```
vagrant@ansi-master1:~/ansitest
$ ansible-playbook test4.yaml

PLAY [register vars] *************************************************************************************

TASK [Input register vars] *******************************************************************************
changed: [ansi-node1]

TASK [Output register vars] ******************************************************************************
ok: [ansi-node1] => {
    "msg": [
        "total 36", 
        "drwxr-xr-x 6 vagrant vagrant 4096 Jan 31 03:32 .", 
        "drwxr-xr-x 4 root    root    4096 Jan 30 02:51 ..", 
        "drwx------ 3 vagrant vagrant 4096 Jan 31 02:20 .ansible", 
        "-rw-r--r-- 1 vagrant vagrant  220 Jan 24 16:59 .bash_logout", 
        "-rw-r--r-- 1 vagrant vagrant 3771 Jan 24 16:59 .bashrc", 
        "drwx------ 2 vagrant vagrant 4096 Jan 30 02:51 .cache", 
        "drwx------ 3 vagrant vagrant 4096 Jan 30 02:51 .gnupg", 
        "-rw-r--r-- 1 vagrant vagrant  807 Jan 24 16:59 .profile", 
        "drwx------ 2 vagrant vagrant 4096 Jan 30 02:51 .ssh", 
        "-rw-r--r-- 1 root    root       0 Jan 31 03:29 test"
    ]
}
```

## 변수 정의 위치
- 인벤토리
- 플레이북
- 재사용 가능 파일(외부 참조 파일)
- 역할
- 명령의 -e 옵션

### 인벤토리
#### 호스트 변수
- INI 형식의 인벤토리에서 변수 선언은 '키=값' 형태를 가짐

![](images/Pasted%20image%2020230131163207.png)

```
$ cat inventory_vars 
[all]
ansi-master1

[AA]
ansi-node1 port=80
ansi-node2 port=8080

[BB]
ansi-node2
ansi-node3

[CC]
ansi-node1
ansi-node3

[ABC:children]
AA
BB
```

호스트 각각에 변수를 지정하고 플레이북 실행 시 기본 인벤토리가 아닌 해당 인벤토리를 참조하도록 하면 플레이북 파일에 변수가 없더라도 변수를 참조하는 것을 확인할 수 있다.

```
vagrant@ansi-master1:~/ansitest
$ cat test4.yaml 
- name: register vars
  hosts: AA
  gather_facts: no
  tasks:
    - name: Print port
      debug:
        msg: "{{ port }}"
vagrant@ansi-master1:~/ansitest
$ ansible-playbook test4.yaml

PLAY [register vars] *************************************************************************************

TASK [Print port] ****************************************************************************************
fatal: [ansi-node1]: FAILED! => {"msg": "The task includes an option with an undefined variable. The error was: 'port' is undefined\n\nThe error appears to be in '/home/vagrant/ansitest/test4.yaml': line 5, column 7, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n  tasks:\n    - name: Print port\n      ^ here\n"}
fatal: [ansi-node2]: FAILED! => {"msg": "The task includes an option with an undefined variable. The error was: 'port' is undefined\n\nThe error appears to be in '/home/vagrant/ansitest/test4.yaml': line 5, column 7, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n  tasks:\n    - name: Print port\n      ^ here\n"}

PLAY RECAP ***********************************************************************************************
ansi-node1                 : ok=0    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   
ansi-node2                 : ok=0    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   

vagrant@ansi-master1:~/ansitest
$ ansible-playbook test4.yaml -i inventory_vars 

PLAY [register vars] *************************************************************************************

TASK [Print port] ****************************************************************************************
ok: [ansi-node1] => {
    "msg": 80
}
ok: [ansi-node2] => {
    "msg": 8080
}

PLAY RECAP ***********************************************************************************************
ansi-node1                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ansi-node2                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 
```

#### 그룹 변수
- 그룹 변수는 `[그룹이름:vars]` 의 꼴로 저장하게 된다.
- 그룹 변수보다는 호스트 변수가 우선하게 된다.
```
vagrant@ansi-master1:~/ansitest
$ cat inventory_vars 
[all]
ansi-master1

[AA]
ansi-node1 
ansi-node2 

[BB]
ansi-node2
ansi-node3

[CC]
ansi-node1
ansi-node3

[ABC:children]
AA
BB

[AA:vars]
port=1010

vagrant@ansi-master1:~/ansitest
$ ansible-playbook test4.yaml -i inventory_vars 

PLAY [register vars] *************************************************************************************

TASK [Print port] ****************************************************************************************
ok: [ansi-node1] => {
    "msg": 1010
}
ok: [ansi-node2] => {
    "msg": 1010
}

PLAY RECAP ***********************************************************************************************
ansi-node1                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ansi-node2                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 
```

### 외부 정의 파일 이용
`host_vars` 디렉토리와 `group_vars` 디렉토리 아래 해당 호스트, 그룹 이름으로 파일을 생성하고 안에 값을 넣어주면 된다.

```
vagrant@ansi-master1:~/ansitest
$ mkdir host_vars
vagrant@ansi-master1:~/ansitest
$ echo "port: 1111" > host_vars/ansi-node1
vagrant@ansi-master1:~/ansitest
$ mkdir group_vars
vagrant@ansi-master1:~/ansitest
$ echo "port: 2222" > group_vars/AA

vagrant@ansi-master1:~/ansitest
$ ansible-playbook test4.yaml

PLAY [register vars] *************************************************************************************

TASK [Print port] ****************************************************************************************
ok: [ansi-node1] => {
    "msg": 1111
}
ok: [ansi-node2] => {
    "msg": 2222
}

PLAY RECAP ***********************************************************************************************
ansi-node1                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ansi-node2                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  
```

### 플레이북
#### 플레이북 내에 정의
- 앞서 한 것 처럼 vars 키워드를 사용해 플레이북 내부에 변수를 정의할 수 있다.

#### 변수 파일
- 플레이에 vars_files 키워드를 사용하여 변수 파일을 포함할 수 있다.
- 변수 파일은 YAML 형식으로 작성
![](images/Pasted%20image%2020230131164624.png)

### 런타임
#### 옵션
- ansible-playbook 명령에 --extra-vars 또는 -e 옵션을 사용하여 변수를 플레이북에 전달할 수 있다.
- 변수 정의는 YAML 형식이 아닌 키=값 형식이나 JSON 문자열 형식으로 선언하거나 JSON 또는 YAML 파일을 지정할 수 있다.

```
$ ansible-playbook test4.yaml -e "port=7777"
[WARNING]: Found variable using reserved name: port

PLAY [register vars] *************************************************************************************

TASK [Print port] ****************************************************************************************
ok: [ansi-node1] => {
    "msg": "7777"
}
ok: [ansi-node2] => {
    "msg": "7777"
}

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ansi-node2                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 
```

## 변수 우선 순위
아래로 갈 수록 우선순위가 높다.

![](images/Pasted%20image%2020230131164934.png)

정의된 변수의 우선순위를 높은 순으로 적어보면 다음과 같다.

extra-vars
playbook vars_files
playbook 변수
host_vars 디렉토리 변수
inventory host_vars
group_vars 디렉토리 변수
inventory group_vars

- host_vars 보다 group_vars 가 우선 한다.
```
[all]
ansi-master1

[AA]
ansi-node1 var1=1000
ansi-node2 

[AA:vars]
var1=2000
```

## 변수 범위
- 번수를 어디에 정의 하느냐에 따라 변수를 참조할 수 있는 범위가 한정되어 있다.
	- 전역/플레이북
		- 구성 파일, 환경 변수(ansible_\*), 명령 줄 옵션
	- 호스트 그룹
		- 인벤토리의 그룹 변수
	- 호스트
		- 인벤토리의 호스트 변수
	- 플레이
		- vars, vars_files, vars_prompt 등 지시어, 역할의 기본 변수(defaults) 및 변수
	- 블록
	- 작업
- 변수 정의 위치에 대한 팁
	- group_vars/all: 모든 호스트에 공통적으로 적용할 변수 설정
	- group_vars/<specific_group>: 특정 호스트 그룹에 공통적으로 적용할 변수 설정
	- host_vars/\<host\>: 특정 호스트에만 적용할 변수 설정
	- 플레이 또는 역할에서만 적용할 변수 설정
	- 특정 작업에만 적용할 변수 설정

# 조회
## 조회 (lookup) 플러그인
- 파일, 인벤토리, 키/값 저장소, API 등 외부 소스에서 데이터를 검색해 변수로 가져올 수 있다.
- 조회 플러그인 목록 확인
```
$ ansible-doc -t lookup -l
```

- file 조회 플러그인을 이용해서 파일의 내용을 가져올 수 있다.
```
- name: file lookup test
  hosts: AA
  vars:
    m_hostname: "{{ lookup('file', '/etc/hostname') }}"
  tasks:
    - name: var print
      ansible.builtin.debug:
        msg: "{{ m_hostname }}"
```

```
$ ansible-playbook file_lookup.yaml 

PLAY [file lookup test] ***************************************************************************************

TASK [Gathering Facts] ****************************************************************************************
ok: [ansi-node1]
ok: [ansi-node2]

TASK [var print] **********************************************************************************************
ok: [ansi-node1] => {
    "msg": "ansi-master1"
}
ok: [ansi-node2] => {
    "msg": "ansi-master1"
}

PLAY RECAP ****************************************************************************************************
ansi-node1                 : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ansi-node2                 : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 
```

- url 조회 플러그인을 이용해 정보를 변수로 지정할 수 있다.
```

```