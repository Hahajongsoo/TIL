# 반복문
- 반복적인 작업을 효율적으로 하기 위해 사용
- loop 구문을 사용해서 각 작업에 대한 반복 작업 수행 가능
- 변수 값을 변경하면서 모듈을 실행( item이라는 이름의 변수 사용 )
- 조건식과는 다르게 block 단위의 반복 작업은 불가
	- 조건식과 함께 사용하는 방식은 가능
- loop 구문에서 변수 선언 시에 리스트 형태 구성도 가능
- 중첩 기능도 제공

## 단순 반복문

```yaml
- name: Loop test
  hosts: ansi-node1
  gather_facts: false
  tasks:
    - name: Add serveral users
      ansible.builtin.user:
        name: "{{ item }}"
      loop:
        - testuser1
        - testuser2
```

```
vagrant@ansi-master1:~/ansitest
$ ansible-playbook ./playbooks/loop_test.yaml 
[WARNING]: Skipping plugin (/home/vagrant/.local/lib/python3.9/site-packages/ansible/plugins/connection/winrm.py), cannot
load: invalid syntax (spawnbase.py, line 224)

PLAY [Loop test] ************************************************************************************************************

TASK [Add serveral users] ***************************************************************************************************
changed: [ansi-node1] => (item=testuser1)
changed: [ansi-node1] => (item=testuser2)

PLAY RECAP ******************************************************************************************************************
ansi-node1                 : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

vagrant@ansi-master1:~/ansitest
$ ssh ansi-node1 cat /etc/passwd | tail -3
ubuntu:x:1001:1001:Ubuntu:/home/ubuntu:/bin/bash
testuser1:x:1002:1002::/home/testuser1:/bin/sh
testuser2:x:1003:1003::/home/testuser2:/bin/sh
```

## 반복문에 변수 참조
- loop에 목록 변수를 직접 지정할 수 있다.

```yaml
- name: Loop test
  hosts: ansi-node1
  gather_facts: false
  vars:
    user_names:
      - list_testuser1
      - list_testuser2
  tasks:
    - name: Add serveral users
      ansible.builtin.user:
        name: "{{ item }}"
      loop:
        "{{ user_names }}"

```

```
vagrant@ansi-master1:~/ansitest
$ ansible-playbook ./playbooks/loop_test.yaml 
[WARNING]: Skipping plugin (/home/vagrant/.local/lib/python3.9/site-packages/ansible/plugins/connection/winrm.py), cannot
load: invalid syntax (spawnbase.py, line 224)

PLAY [Loop test] ****************************************************************************************

TASK [Add serveral users] ***************************************************************************************************
changed: [ansi-node1] => (item=list_testuser1)
changed: [ansi-node1] => (item=list_testuser2)

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

vagrant@ansi-master1:~/ansitest
$ ssh ansi-node1 cat /etc/passwd | tail -3
testuser2:x:1003:1003::/home/testuser2:/bin/sh
list_testuser1:x:1004:1004::/home/list_testuser1:/bin/sh
list_testuser2:x:1005:1005::/home/list_testuser2:/bin/sh
```

```yaml
- name: Loop test
  hosts: ansi-node1
  gather_facts: false
  tasks:
    - name: Command ls 
      ansible.builtin.command:
        cmd: "ls -al /root"
      register: result
    - name: Print stdout
      ansible.builtin.debug:
        msg: "{{ item }}"
      loop:
        "{{ result.stdout_lines }}"

```

```
$ ansible-playbook ./playbooks/loop_test.yaml 
[WARNING]: Skipping plugin (/home/vagrant/.local/lib/python3.9/site-packages/ansible/plugins/connection/winrm.py), cannot
load: invalid syntax (spawnbase.py, line 224)

PLAY [Loop test] ****************************************************************************************

TASK [Command ls] ****************************************************************************************
changed: [ansi-node1]

TASK [Print stdout] ****************************************************************************************
ok: [ansi-node1] => (item=total 20) => {
    "msg": "total 20"
}
ok: [ansi-node1] => (item=drwx------  3 root root 4096 Jan 30 02:51 .) => {
    "msg": "drwx------  3 root root 4096 Jan 30 02:51 ."
}
ok: [ansi-node1] => (item=drwxr-xr-x 24 root root 4096 Jan 30 02:51 ..) => {
    "msg": "drwxr-xr-x 24 root root 4096 Jan 30 02:51 .."
}
ok: [ansi-node1] => (item=-rw-r--r--  1 root root 3106 Apr  9  2018 .bashrc) => {
    "msg": "-rw-r--r--  1 root root 3106 Apr  9  2018 .bashrc"
}
ok: [ansi-node1] => (item=-rw-r--r--  1 root root  148 Aug 17  2015 .profile) => {
    "msg": "-rw-r--r--  1 root root  148 Aug 17  2015 .profile"
}
ok: [ansi-node1] => (item=drwx------  2 root root 4096 Jan 30 02:51 .ssh) => {
    "msg": "drwx------  2 root root 4096 Jan 30 02:51 .ssh"
}

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  
```

## 사전 목록 반복
- 변수를 참조하는 방법은 `item.<dict_key>` 형식으로 참조
```yaml
- name: Loop test
  hosts: ansi-node1
  gather_facts: false
  vars:
    info:
      - name: Lee
        age: 15
      - name: Kim
        age: 28
      - name: Ha
        age: 29
  tasks:
    - name: Print vars
      ansible.builtin.debug:
        msg: "name: {{ item.name }}, age: {{ item.age }}"
      loop:
        "{{ info }}"

```

```
$ ansible-playbook ./playbooks/loop_test.yaml 
[WARNING]: Skipping plugin (/home/vagrant/.local/lib/python3.9/site-packages/ansible/plugins/connection/winrm.py), cannot
load: invalid syntax (spawnbase.py, line 224)

PLAY [Loop test] ****************************************************************************************

TASK [Print vars] ****************************************************************************************
ok: [ansi-node1] => (item={'name': 'Lee', 'age': 15}) => {
    "msg": "name: Lee, age: 15"
}
ok: [ansi-node1] => (item={'name': 'Kim', 'age': 28}) => {
    "msg": "name: Kim, age: 28"
}
ok: [ansi-node1] => (item={'name': 'Ha', 'age': 29}) => {
    "msg": "name: Ha, age: 29"
}

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 
```

## 중첩 목록 반복
- 여러 개의 목록을 결합(데카르트 곱) 가능
```yaml
- name: Loop test
  hosts: ansi-node1
  gather_facts: false
  vars:
    list1:
      - 1
      - 2
    list2:
      - a
      - b
      - c
  tasks:
    - name: Print multi list vars
      ansible.builtin.debug:
        msg: "number: {{ item[0] }}, alphabet: {{ item[1] }}"
      loop:
        "{{ list1 | product(list2) | list }}"

```

```
$ ansible-playbook ./playbooks/loop_test.yaml 
[WARNING]: Skipping plugin (/home/vagrant/.local/lib/python3.9/site-packages/ansible/plugins/connection/winrm.py), cannot
load: invalid syntax (spawnbase.py, line 224)

PLAY [Loop test] ****************************************************************************************

TASK [Print multi list vars] ****************************************************************************************
ok: [ansi-node1] => (item=[1, 'a']) => {
    "msg": "number: 1, alphabet: a"
}
ok: [ansi-node1] => (item=[1, 'b']) => {
    "msg": "number: 1, alphabet: b"
}
ok: [ansi-node1] => (item=[1, 'c']) => {
    "msg": "number: 1, alphabet: c"
}
ok: [ansi-node1] => (item=[2, 'a']) => {
    "msg": "number: 2, alphabet: a"
}
ok: [ansi-node1] => (item=[2, 'b']) => {
    "msg": "number: 2, alphabet: b"
}
ok: [ansi-node1] => (item=[2, 'c']) => {
    "msg": "number: 2, alphabet: c"
}

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

## 인벤토리 반복
- 인벤토리 호스트 목록을 반복문을 통해 가져올 수 있다.