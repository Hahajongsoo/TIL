# 반복문
- 반복적인 작업을 효율적으로 하기 위해 사용
- loop 구문을 사용해서 각 작업에 대한 반복 작업 수행 가능
- 변수 값을 변경하면서 모듈을 실행( item이라는 이름의 변수 사용 )
- 조건식과는 다르게 block 단위의 반복 작업은 불가
	- 조건식과 함께 사용하는 방식은 가능
- loop 구문에서 변수 선언 시에 리스트 형태 구성도 가능
- 중첩 기능도 제공

## 단순 반복문

```yaml
- name: Loop test
  hosts: ansi-node1
  gather_facts: false
  tasks:
    - name: Add serveral users
      ansible.builtin.user:
        name: "{{ item }}"
      loop:
        - testuser1
        - testuser2
```

```
vagrant@ansi-master1:~/ansitest
$ ansible-playbook ./playbooks/loop_test.yaml 
[WARNING]: Skipping plugin (/home/vagrant/.local/lib/python3.9/site-packages/ansible/plugins/connection/winrm.py), cannot
load: invalid syntax (spawnbase.py, line 224)

PLAY [Loop test] ************************************************************************************************************

TASK [Add serveral users] ***************************************************************************************************
changed: [ansi-node1] => (item=testuser1)
changed: [ansi-node1] => (item=testuser2)

PLAY RECAP ******************************************************************************************************************
ansi-node1                 : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

vagrant@ansi-master1:~/ansitest
$ ssh ansi-node1 cat /etc/passwd | tail -3
ubuntu:x:1001:1001:Ubuntu:/home/ubuntu:/bin/bash
testuser1:x:1002:1002::/home/testuser1:/bin/sh
testuser2:x:1003:1003::/home/testuser2:/bin/sh
```

## 반복문에 변수 참조
- loop에 목록 변수를 직접 지정할 수 있다.

```yaml
- name: Loop test
  hosts: ansi-node1
  gather_facts: false
  vars:
    user_names:
      - list_testuser1
      - list_testuser2
  tasks:
    - name: Add serveral users
      ansible.builtin.user:
        name: "{{ item }}"
      loop:
        "{{ user_names }}"

```

```
vagrant@ansi-master1:~/ansitest
$ ansible-playbook ./playbooks/loop_test.yaml 
[WARNING]: Skipping plugin (/home/vagrant/.local/lib/python3.9/site-packages/ansible/plugins/connection/winrm.py), cannot
load: invalid syntax (spawnbase.py, line 224)

PLAY [Loop test] ****************************************************************************************

TASK [Add serveral users] ***************************************************************************************************
changed: [ansi-node1] => (item=list_testuser1)
changed: [ansi-node1] => (item=list_testuser2)

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

vagrant@ansi-master1:~/ansitest
$ ssh ansi-node1 cat /etc/passwd | tail -3
testuser2:x:1003:1003::/home/testuser2:/bin/sh
list_testuser1:x:1004:1004::/home/list_testuser1:/bin/sh
list_testuser2:x:1005:1005::/home/list_testuser2:/bin/sh
```

```yaml
- name: Loop test
  hosts: ansi-node1
  gather_facts: false
  tasks:
    - name: Command ls 
      ansible.builtin.command:
        cmd: "ls -al /root"
      register: result
    - name: Print stdout
      ansible.builtin.debug:
        msg: "{{ item }}"
      loop:
        "{{ result.stdout_lines }}"

```

```
$ ansible-playbook ./playbooks/loop_test.yaml 
[WARNING]: Skipping plugin (/home/vagrant/.local/lib/python3.9/site-packages/ansible/plugins/connection/winrm.py), cannot
load: invalid syntax (spawnbase.py, line 224)

PLAY [Loop test] ****************************************************************************************

TASK [Command ls] ****************************************************************************************
changed: [ansi-node1]

TASK [Print stdout] ****************************************************************************************
ok: [ansi-node1] => (item=total 20) => {
    "msg": "total 20"
}
ok: [ansi-node1] => (item=drwx------  3 root root 4096 Jan 30 02:51 .) => {
    "msg": "drwx------  3 root root 4096 Jan 30 02:51 ."
}
ok: [ansi-node1] => (item=drwxr-xr-x 24 root root 4096 Jan 30 02:51 ..) => {
    "msg": "drwxr-xr-x 24 root root 4096 Jan 30 02:51 .."
}
ok: [ansi-node1] => (item=-rw-r--r--  1 root root 3106 Apr  9  2018 .bashrc) => {
    "msg": "-rw-r--r--  1 root root 3106 Apr  9  2018 .bashrc"
}
ok: [ansi-node1] => (item=-rw-r--r--  1 root root  148 Aug 17  2015 .profile) => {
    "msg": "-rw-r--r--  1 root root  148 Aug 17  2015 .profile"
}
ok: [ansi-node1] => (item=drwx------  2 root root 4096 Jan 30 02:51 .ssh) => {
    "msg": "drwx------  2 root root 4096 Jan 30 02:51 .ssh"
}

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  
```

## 사전 목록 반복
- 변수를 참조하는 방법은 `item.<dict_key>` 형식으로 참조
```yaml
- name: Loop test
  hosts: ansi-node1
  gather_facts: false
  vars:
    info:
      - name: Lee
        age: 15
      - name: Kim
        age: 28
      - name: Ha
        age: 29
  tasks:
    - name: Print vars
      ansible.builtin.debug:
        msg: "name: {{ item.name }}, age: {{ item.age }}"
      loop:
        "{{ info }}"

```

```
$ ansible-playbook ./playbooks/loop_test.yaml 
[WARNING]: Skipping plugin (/home/vagrant/.local/lib/python3.9/site-packages/ansible/plugins/connection/winrm.py), cannot
load: invalid syntax (spawnbase.py, line 224)

PLAY [Loop test] ****************************************************************************************

TASK [Print vars] ****************************************************************************************
ok: [ansi-node1] => (item={'name': 'Lee', 'age': 15}) => {
    "msg": "name: Lee, age: 15"
}
ok: [ansi-node1] => (item={'name': 'Kim', 'age': 28}) => {
    "msg": "name: Kim, age: 28"
}
ok: [ansi-node1] => (item={'name': 'Ha', 'age': 29}) => {
    "msg": "name: Ha, age: 29"
}

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 
```

## 중첩 목록 반복
- 여러 개의 목록을 결합(데카르트 곱) 가능
```yaml
- name: Loop test
  hosts: ansi-node1
  gather_facts: false
  vars:
    list1:
      - 1
      - 2
    list2:
      - a
      - b
      - c
  tasks:
    - name: Print multi list vars
      ansible.builtin.debug:
        msg: "number: {{ item[0] }}, alphabet: {{ item[1] }}"
      loop:
        "{{ list1 | product(list2) | list }}"

```

```
$ ansible-playbook ./playbooks/loop_test.yaml 
[WARNING]: Skipping plugin (/home/vagrant/.local/lib/python3.9/site-packages/ansible/plugins/connection/winrm.py), cannot
load: invalid syntax (spawnbase.py, line 224)

PLAY [Loop test] ****************************************************************************************

TASK [Print multi list vars] ****************************************************************************************
ok: [ansi-node1] => (item=[1, 'a']) => {
    "msg": "number: 1, alphabet: a"
}
ok: [ansi-node1] => (item=[1, 'b']) => {
    "msg": "number: 1, alphabet: b"
}
ok: [ansi-node1] => (item=[1, 'c']) => {
    "msg": "number: 1, alphabet: c"
}
ok: [ansi-node1] => (item=[2, 'a']) => {
    "msg": "number: 2, alphabet: a"
}
ok: [ansi-node1] => (item=[2, 'b']) => {
    "msg": "number: 2, alphabet: b"
}
ok: [ansi-node1] => (item=[2, 'c']) => {
    "msg": "number: 2, alphabet: c"
}

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

## 인벤토리 반복
- 인벤토리 호스트 목록을 반복문을 통해 가져올 수 있다.


# 조건문
## 조건문
- ansible은 조건문을 사용하여 특정 조건을 충족하는 작업 또는 플레이를 실행할 수 있다.
- 서비스를 설치하거나 구성하기 전에 관리 호스트에서 사용 가능한 메모리를 확인하는 데 조건 문을 사용할 수 있다.
- 조건문을 사용하여 관리자가 관리 호스트간의 차이점을 구분하고 충족된 조건을 기반으로 하여 기능 역할을 할당할 수 있다.
- 플레이북 변수, 등록된 변수 및 Ansible 팩트는 모두 조건문을 사용하여 테스트 할 수 있다.
- Ansible 조건부에서 테스트 및 필터를 사용
- 테스트는 표현식을 평가하고 True와 False를 반환한다.
- 조건문에서 변수를 참조하더라도 변수명에 {{}} 이중 중괄호를 사용하지 않는다. 

### 문자열 테스트
```yaml
- name: Condition test
  hosts: ansi-node1
  gather_facts: false
  vars:
    url: "http://www.nobreak.co.kr/guest/document/index.html"
  tasks:
    - name: Test1
      ansible.builtin.debug:
        msg: "match pattern 1"
      when: url is match("http://")
    - name: Test2
      ansible.builtin.debug:
        msg: "match pattern 2"
      when: url is match("http://[a-z]*.nobreak")
    - name: Test3
      ansible.builtin.debug:
        msg: "match pattern 3"
      when: url is match("nodirect")
    - name: Test4
      ansible.builtin.debug:
        msg: "match pattern 4"
      when: url is match("http://.*html")

```

```
$ ansible-playbook ./playbooks/condition.yaml 
[WARNING]: Skipping plugin (/home/vagrant/.local/lib/python3.9/site-
packages/ansible/plugins/connection/winrm.py), cannot load: invalid syntax (spawnbase.py, line 224)

PLAY [Condition test] ******************************************************************************

TASK [Test1] ***************************************************************************************
ok: [ansi-node1] => {
    "msg": "match pattern 1"
}

TASK [Test2] ***************************************************************************************
ok: [ansi-node1] => {
    "msg": "match pattern 2"
}

TASK [Test3] ***************************************************************************************
skipping: [ansi-node1]

TASK [Test4] ***************************************************************************************
ok: [ansi-node1] => {
    "msg": "match pattern 4"
}

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=3    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
```

### 버전 비교 테스트

```yaml
- name: Condition test
  hosts: ansi-node1
  gather_facts: false
  vars:
    my_version: 1.2.1
  tasks:
    - name: Test1
      ansible.builtin.debug:
        msg: "version is greater than 1.0.5"
      when: my_version is version('1.0.5', '>')
    - name: Test2
      ansible.builtin.debug:
        msg: "version is less than 1.0.0"
      when: my_version is version('1.0.0', 'lt')

```

```
$ ansible-playbook ./playbooks/condition.yaml 

PLAY [Condition test] ****************************************************************************************

TASK [Test1] ****************************************************************************************
ok: [ansi-node1] => {
    "msg": "version is greater than 1.0.5"
}

TASK [Test2] ****************************************************************************************
skipping: [ansi-node1]

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=1    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0 
```

### 경로 테스트

```yaml
- name: path
  hosts: ansi-node1
  gather_facts: no
  vars:
    path_list:
      - /etc/passwd
      - /etc/
      - /home/vagrant/
      - /home/vagrant/filea
      - /etc/
      - /
  tasks:
  - debug:
      msg: "{{ item }} is file"
    loop: "{{ path_list }}"
    when: item is file

  - debug:
      msg: "{{ item }} is dir"
    loop: "{{ path_list }}"
    when: item is directory

  - debug:
      msg: "{{ item }} is exists"
    loop: "{{ path_list }}"
    when: item is exists

  - debug:
      msg: "{{ item }} is mount"
    loop: "{{ path_list }}"
    when: item is mount
```


### 작업 상태 테스트
```yaml
- name: Condition test
  hosts: ansi-node1
  tasks:
    - shell: /usr/bin/foo
      register: result
      ignore_errors: True
    - debug:
        msg: "it failed"
      when: result is failed
    - debug:
        msg: "it changed"
      when: result is changed
    - debug:
        msg: "it succeeded in Ansible >= 2.1"
      when: result is succeeded
    - debug:
        msg: "it succeeded"
      when: result is success
    - debug:
       msg: "it was skipped"
      when: result is skipped
```


```
$ ansible-playbook ./playbooks/condition.yaml 
[WARNING]: Skipping plugin (/home/vagrant/.local/lib/python3.9/site-packages/ansible/plugins/connection/winrm.py), cannot
load: invalid syntax (spawnbase.py, line 224)

PLAY [Condition test] ******************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************
ok: [ansi-node1]

TASK [shell] ***************************************************************************************************************
fatal: [ansi-node1]: FAILED! => {"changed": true, "cmd": "/usr/bin/foo", "delta": "0:00:00.002201", "end": "2023-02-03 05:48:43.825925", "msg": "non-zero return code", "rc": 127, "start": "2023-02-03 05:48:43.823724", "stderr": "/bin/sh: 1: /usr/bin/foo: not found", "stderr_lines": ["/bin/sh: 1: /usr/bin/foo: not found"], "stdout": "", "stdout_lines": []}
...ignoring

TASK [debug] ****************************************************************************************
ok: [ansi-node1] => {
    "msg": "it failed"
}

TASK [debug] ****************************************************************************************
ok: [ansi-node1] => {
    "msg": "it changed"
}

TASK [debug] ****************************************************************************************
skipping: [ansi-node1]

TASK [debug] ****************************************************************************************
skipping: [ansi-node1]

TASK [debug] ****************************************************************************************
skipping: [ansi-node1]

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=4    changed=1    unreachable=0    failed=0    skipped=3    rescued=0    ignored=1
```

## 조건문 작업 구문
- 작업 또는 플레이북을 실행하면 ansible은 호스트에 대한 테스트를 평가한다.
- 테스트를 통과한 모든 호스트에서 ansible은 해당 작업을 실행한다.
- SELinux가 비활성화된 시스템에서만 해당 작업이 실행되는 예시
```yaml
- name: Condition test
  hosts: ABC
  tasks:
    - name: Echo
      ansible.builtin.command:
        cmd: "echo 'selinux disabled'"
      when: ansible_selinux.status == "disabled"

```

```
$ ansible-playbook ./playbooks/condition.yaml -v
Using /home/vagrant/ansitest/ansible.cfg as config file


PLAY [Condition test] ****************************************************************************************

TASK [Gathering Facts] ****************************************************************************************
ok: [ansi-node2]
ok: [ansi-node3]
ok: [ansi-node1]

TASK [Echo] ****************************************************************************************
changed: [ansi-node2] => {"changed": true, "cmd": ["echo", "selinux disabled"], "delta": "0:00:00.005167", "end": "2023-02-03 05:55:10.427609", "msg": "", "rc": 0, "start": "2023-02-03 05:55:10.422442", "stderr": "", "stderr_lines": [], "stdout": "selinux disabled", "stdout_lines": ["selinux disabled"]}
changed: [ansi-node3] => {"changed": true, "cmd": ["echo", "selinux disabled"], "delta": "0:00:00.005883", "end": "2023-02-03 05:55:10.428302", "msg": "", "rc": 0, "start": "2023-02-03 05:55:10.422419", "stderr": "", "stderr_lines": [], "stdout": "selinux disabled", "stdout_lines": ["selinux disabled"]}
changed: [ansi-node1] => {"changed": true, "cmd": ["echo", "selinux disabled"], "delta": "0:00:00.002267", "end": "2023-02-03 05:55:10.425777", "msg": "", "rc": 0, "start": "2023-02-03 05:55:10.423510", "stderr": "", "stderr_lines": [], "stdout": "selinux disabled", "stdout_lines": ["selinux disabled"]}

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ansi-node2                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ansi-node3                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

## fact 변수 기반 조건문
- fact를 기반으로 작업을 실행하거나 건너뛰고 싶은 경우가 있다.
- fact는 IP 주소, 운영 체제, 파일 시스템 상태 등을 포함한 개별 호스트의 속성
- fact에 기반한 조건문 사용 경우
	- 운영 체제가 특정 버전인 경우에만 특정 패키지를 설치
	- 내부 IP 주소가 있는 호스트에서 방화벽 구성 스킵
	- 파일 시스템이 가득 차면 정리 작업을 수행
- 특정 조건인 경우 실행
```yaml
- name: Condition test
  hosts: ABC
  tasks:
    - name: Shut down Debian flavored systems
      ansible.builtin.command: /sbin/shutdown -t now
      when: ansible_facts['os_family'] == "Debian"

```
- fact 내용이 목록 변수에 해당 유무에 따른 실행
```yaml
- name: Condition test
  hosts: ABC
  vars:
    supported_distros:
      - Centos
      - Fedora
  tasks:
    - name: Install httpd using yum, where supported
      ansible.builtin.yum:
        name: httpd
        state: present
      when: ansible_distribution in supported_distros

```

## 복수 조건에 따른 실행
- 조건을 리스트로 표현하면 and 연산이 적용된다.
```yaml
- name: Condition test
  hosts: ABC
  tasks:
    - name: Shut down CentOS 6 systems
      ansible.builtin.command: /sbin/shutdown -t now
      when:
        - ansible_facts['distribution'] == "CentOS"
        - ansible_facts['distribution_major_version'] == "6"

```
- 괄호로 연산 우선 순위를 지정할 수도 있다.
```yaml
- name: Condition test
  hosts: ABC
  tasks:
    - name: Shut down CentOS 6 and Debian 7 systems
      ansible.builtin.command: /sbin/shutdown -t now
      when:
        (ansible_facts['distribution'] == "CentOS" and ansible_facts['distribution_major_version'] == "6")
        or
        (ansible_facts['distribution'] == "Debian" and ansible_facts['distribution_major_version'] == "7")

```

## register 변수에 따른 조건
- 플레이북에서 이전 작업의 결과에 따라 작업을 실행하거나 건너뛰고 싶을 때 사용
- register 변수에는 항상 변수를 생성한 작업의 상태와 작업이 생성한 모든 출력이 포함된다.
- register는 템플릿과 액션 라인 뿐만 아니라 조건문에서도 사용 가능하다.

- ls로 확인 시, 경로에 아무것도 없는 경우 생성
```yaml
- name: Condition test
  hosts: ansi-node2
  tasks:
    - name: List root path
      ansible.builtin.command:
        cmd: ls
      register: ls_result
    - name: Print when emtpy
      ansible.builtin.debug:
        msg: "/home/vagrant is emtpy"
      when: ls_result.stdout == ''
    - name: Print when not empty
      ansible.builtin.debug:
        msg: "/home/vagrant is not emtpy"
      when: ls_result.stdout != ''
    - name: Create file
      ansible.builtin.file:
        state: touch
        dest: /home/vagrant/testfile
        mode: 0664
      when: ls_result.stdout == ''

```

```
vagrant@ansi-master1:~/ansitest
$ ansible-playbook ./playbooks/condition.yaml
[WARNING]: Skipping plugin (/home/vagrant/.local/lib/python3.9/site-packages/ansible/plugins/connection/winrm.py), cannot load: invalid syntax (spawnbase.py, line 224)

PLAY [Condition test] ****************************************************************************************

TASK [Gathering Facts] ****************************************************************************************
ok: [ansi-node2]
ok: [ansi-node1]

TASK [List root path] ****************************************************************************************
changed: [ansi-node2]
changed: [ansi-node1]

TASK [Print when emtpy] ****************************************************************************************
skipping: [ansi-node1]
ok: [ansi-node2] => {
    "msg": "/home/vagrant is emtpy"
}

TASK [Print when not empty] ****************************************************************************************
ok: [ansi-node1] => {
    "msg": "/home/vagrant is not emtpy"
}
skipping: [ansi-node2]

TASK [Create file] ****************************************************************************************
skipping: [ansi-node1]
changed: [ansi-node2]

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=3    changed=1    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   
ansi-node2                 : ok=4    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0  
```

- 변수가 목록이 아닌 경우 split() 을 사용하여 목록으로 변환 가능
```yaml
- name: Condition test
  hosts: ansi-node1
  tasks:
    - ansible.builtin.command:
        cmd: ls -l
      register: ls_result
    - name: Print stdout
      ansible.builtin.debug:
        msg: "{{ ls_result.stdout }}"
    - name: Print stdout_lines
      ansible.builtin.debug:
        msg: "{{ ls_result.stdout_lines }}"
    - name: Print stdout using loop
      ansible.builtin.debug:
        msg: "{{ item }}"
      loop:
        "{{ ls_result.stdout.split('\n') }}"

```

```
$ ansible-playbook ./playbooks/condition.yaml
[WARNING]: Skipping plugin (/home/vagrant/.local/lib/python3.9/site-packages/ansible/plugins/connection/winrm.py), cannot load: invalid syntax (spawnbase.py, line 224)

PLAY [Condition test] ****************************************************************************************

TASK [Gathering Facts] ****************************************************************************************
ok: [ansi-node1]

TASK [ansible.builtin.command] ****************************************************************************************
changed: [ansi-node1]

TASK [Print stdout] ****************************************************************************************
ok: [ansi-node1] => {
    "msg": "total 0\n-rw-rw-r-- 1 vagrant vagrant 0 Feb  3 05:40 file1\n-rw-rw-r-- 1 vagrant vagrant 0 Feb  3 05:42 file2"
}

TASK [Print stdout_lines] ****************************************************************************************
ok: [ansi-node1] => {
    "msg": [
        "total 0",
        "-rw-rw-r-- 1 vagrant vagrant 0 Feb  3 05:40 file1",
        "-rw-rw-r-- 1 vagrant vagrant 0 Feb  3 05:42 file2"
    ]
}

TASK [Print stdout using loop] ****************************************************************************************
ok: [ansi-node1] => (item=total 0) => {
    "msg": "total 0"
}
ok: [ansi-node1] => (item=-rw-rw-r-- 1 vagrant vagrant 0 Feb  3 05:40 file1) => {
    "msg": "-rw-rw-r-- 1 vagrant vagrant 0 Feb  3 05:40 file1"
}
ok: [ansi-node1] => (item=-rw-rw-r-- 1 vagrant vagrant 0 Feb  3 05:42 file2) => {
    "msg": "-rw-rw-r-- 1 vagrant vagrant 0 Feb  3 05:42 file2"
}

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=5    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  
```

## 변수 기반 조건부
- 플레이북이나 인벤토리에 정의된 변수를 기반으로 조건문을 생성
- 조건문에는 부울 입력이 필요하기 때문에 부울이 아닌 변수에 필터를 적용한다. 

```yaml
- name: Condition test
  hosts: ansi-node1
  vars:
    epic: true
    monumental: "yes"
  tasks:
    - name: Run the command if "epic" or "monumental" is true
      ansible.builtin.shell: echo "This certainly is epic!"
      when: epic or monumental | bool
    - name: Run the command if "epic" is false
      ansible.builtin.shell: echo "This certainly isn't epic!"
      when: not epic

```

```
$ ansible-playbook ./playbooks/condition.yaml -v
Using /home/vagrant/ansitest/ansible.cfg as config file
[WARNING]: Skipping plugin (/home/vagrant/.local/lib/python3.9/site-packages/ansible/plugins/connection/winrm.py), cannot load:
invalid syntax (spawnbase.py, line 224)

PLAY [Condition test] ***************************************************************************************

TASK [Gathering Facts] ****************************************************************************************
ok: [ansi-node1]

TASK [Run the command if "epic" or "monumental" is true] ****************************************************************************
changed: [ansi-node1] => {"changed": true, "cmd": "echo \"This certainly is epic!\"", "delta": "0:00:00.001941", "end": "2023-02-03 06:37:17.344183", "msg": "", "rc": 0, "start": "2023-02-03 06:37:17.342242", "stderr": "", "stderr_lines": [], "stdout": "This certainly is epic!", "stdout_lines": ["This certainly is epic!"]}

TASK [Run the command if "epic" is false] *************************************************************************************
skipping: [ansi-node1] => {"changed": false, "skip_reason": "Conditional result was False"}

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=2    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
```

## 조건문과 반복문 결합
- when 명령문을 loop와 결합하면 각 항목에 대해 조건을 개별적으로 처리한다.
- 루프의 일부 항목에 대해서는 작업을 실행하고 다른 항목에서는 건너 뛸 수 있다.
```yaml
- name: Condition test
  hosts: ansi-node1
  vars:
    epic: true
    monumental: "yes"
  tasks:
    - name: Run with items greater than 5
      ansible.builtin.command: echo {{ item }}
      loop: [0, 2, 4, 6, 8, 10]
      when: item > 5

```

```yaml
- name: Condition test
  hosts: ansi-node1
  vars:
    user_info:
      - name: Ha
        age: 29
      - name: Lee
        age: 27
      - name: Kim
        age: 28
  tasks:
    - name: Run with ages older than equal 28
      ansible.builtin.command: echo {{ item.name }}
      loop: "{{ user_info }}"
      when: item.age >= 28

```

## Stat 모듈
- Ansible stat 모듈을 사용하여 파일의 세부 정보를 확인할 수 있다.
- stat 모듈은 linux stat 명령을 사용하여 작업에 지정된 경로를 확인한다. 

```yaml
- hosts: ansi-node1
  tasks:
  - stat:
      path: /etc/passwd
    register: result

  - ansible.builtin.debug:
      msg: "{{ result }}"

  - debug:
      msg: "Ansible When File Exists Example."
    when: result.stat.exists
```


```
$ ansible-playbook ./playbooks/condition.yaml -v
Using /home/vagrant/ansitest/ansible.cfg as config file
[WARNING]: Skipping plugin (/home/vagrant/.local/lib/python3.9/site-packages/ansible/plugins/connection/winrm.py), cannot load: invalid syntax (spawnbase.py, line 224)

PLAY [ansi-node1] ****************************************************************************************

TASK [Gathering Facts] ****************************************************************************************
ok: [ansi-node1]

TASK [stat] ****************************************************************************************
ok: [ansi-node1] => {"changed": false, "stat": {"atime": 1675387304.003001, "attr_flags": "e", "attributes": ["extents"], "block_size": 4096, "blocks": 8, "charset": "us-ascii", "checksum": "5355a6bebb212c3a20129de68e40b56ff980dc2f", "ctime": 1675047100.968, "dev": 2049, "device_type": 0, "executable": false, "exists": true, "gid": 0, "gr_name": "root", "inode": 68100, "isblk": false, "ischr": false, "isdir": false, "isfifo": false, "isgid": false, "islnk": false, "isreg": true, "issock": false, "isuid": false, "mimetype": "text/plain", "mode": "0644", "mtime": 1675047100.956, "nlink": 1, "path": "/etc/passwd", "pw_name": "root", "readable": true, "rgrp": true, "roth": true, "rusr": true, "size": 1609, "uid": 0, "version": "1346065541", "wgrp": false, "woth": false, "writeable": true, "wusr": true, "xgrp": false, "xoth": false, "xusr": false}}

TASK [ansible.builtin.debug] ****************************************************************************************
ok: [ansi-node1] => {
    "msg": {
        "changed": false,
        "failed": false,
        "stat": {
            "atime": 1675387304.003001,
            "attr_flags": "e",
            "attributes": [
                "extents"
            ],
            "block_size": 4096,
            "blocks": 8,
            "charset": "us-ascii",
            "checksum": "5355a6bebb212c3a20129de68e40b56ff980dc2f",
            "ctime": 1675047100.968,
            "dev": 2049,
            "device_type": 0,
            "executable": false,
            "exists": true,
            "gid": 0,
            "gr_name": "root",
            "inode": 68100,
            "isblk": false,
            "ischr": false,
            "isdir": false,
            "isfifo": false,
            "isgid": false,
            "islnk": false,
            "isreg": true,
            "issock": false,
            "isuid": false,
            "mimetype": "text/plain",
            "mode": "0644",
            "mtime": 1675047100.956,
            "nlink": 1,
            "path": "/etc/passwd",
            "pw_name": "root",
            "readable": true,
            "rgrp": true,
            "roth": true,
            "rusr": true,
            "size": 1609,
            "uid": 0,
            "version": "1346065541",
            "wgrp": false,
            "woth": false,
            "writeable": true,
            "wusr": true,
            "xgrp": false,
            "xoth": false,
            "xusr": false
        }
    }
}

TASK [debug] ****************************************************************************************
ok: [ansi-node1] => {
    "msg": "Ansible When File Exists Example."
}

PLAY RECAP ****************************************************************************************
ansi-node1                 : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 
```