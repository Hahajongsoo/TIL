# Ansible 구성 파일
- Ansible 의 작동 방식을 구성하는 파일
- 인벤토리 파일의 위치, 관리 노드에 연결하는 방법, 연결 한 후 작동 방법 등 무수히 많은 구성을 지정할 수 있음
- 기본 Ansible 구성 파일의 위치는 `/etc/ansible/ansible.cfg`

## Ansible 구성 파일 우선순위
1. `ANSIBLE_CONFIG` 환경 변수
2. 현재 디렉토리의 `ansible.cfg`
3. 홈 디렉토리의 `~/.ansible.cfg`
4. `/etc/ansible/ansible.cfg`

우선순위가 높은 파일에 정의된 값이 이전 정의된 값보다 우선한다.

### 파일 내용 수정하고 `ansible-config view` 로 내용 확인하기

1. `/etc/ansible/ansible.cfg`
```
vagrant@ansi-master1:~/ansitest
$ cat /etc/ansible/ansible.cfg | head -3
# 1
# config file for ansible -- https://ansible.com/
# ===============================================
vagrant@ansi-master1:~/ansitest
$ ansible-config view | head -3
# 1
# config file for ansible -- https://ansible.com/
# ===============================================
```

2. `~/.ansible.cfg` 파일 추가
```
vagrant@ansi-master1:~/ansitest
$ cat ~/.ansible.cfg | head -3
# 2
# config file for ansible -- https://ansible.com/
# ===============================================
vagrant@ansi-master1:~/ansitest
$ ansible-config view | head -3
# 2
# config file for ansible -- https://ansible.com/
# ===============================================
```

3. 현재 디렉토리의 `ansible.cfg` 파일 추가
```
vagrant@ansi-master1:~/ansitest
$ cat ansible.cfg | head -3
# 3
# config file for ansible -- https://ansible.com/
# ===============================================
vagrant@ansi-master1:~/ansitest
$ ansible-config view | head -3
# 3
# config file for ansible -- https://ansible.com/
# ===============================================
```

## Ansible 작동 방식 제어 우선 순위
- Ansible 작동 방식을 제어하기 위해 Ansible 구성 파일 외에도 `ansible` 명령의 옵션, 플레이북 키워드, 변수를 이용해 동작을 제어할 수 있다.
1. `-e` 옵션에 지정한 변수
2. 변수
3. 플레이북 키워드
4. 명령의 옵션
5. Ansible 구성 파일

## ansible.cfg 구성 파일 설정
- `[section]` 대괄호로 묶여진 여러 섹션이 있고 각 섹션에는 키 = 값 으로 설정된 설정이 포함된다.
![](images/Pasted%20image%2020230130141530.png)

### 구성 파일 및 설정 확인
- 파일 내용을 편집기로 확인할 수도 있지만 `ansible-config` 명령을 이용해 구성 파일 및 설정에 대해 확인할 수 있다.
- 일반적으로 현재 디렉토리에 있는 설정파일을 사용한다.

- 현재 적용된 구성 파일의 내용 확인
```
vagrant@ansi-master1:~/ansitest
$ ansible-config view
# config file for ansible -- https://ansible.com/
# ===============================================

# nearly all parameters can be overridden in ansible-playbook
# or with command line flags. ansible will read ANSIBLE_CONFIG,
# ansible.cfg in the current working directory, .ansible.cfg in
# the home directory or /etc/ansible/ansible.cfg, whichever it
# finds first

[defaults]

# some basic default values...

#inventory      = /etc/ansible/hosts
#library        = /usr/share/my_modules/
#module_utils   = /usr/share/my_module_utils/
#remote_tmp     = ~/.ansible/tmp
#local_tmp      = ~/.ansible/tmp
#plugin_filters_cfg = /etc/ansible/plugin_filters.yml
#forks          = 5
#poll_interval  = 15
#sudo_user      = root
#ask_sudo_pass = True
...
```

- 현재 적용된 모든 구성 정보 확인
```
vagrant@ansi-master1:~/ansitest
$ ansible-config dump
ACTION_WARNINGS(default) = True
AGNOSTIC_BECOME_PROMPT(default) = True
ALLOW_WORLD_READABLE_TMPFILES(default) = False
ANSIBLE_CONNECTION_PATH(default) = None
ANSIBLE_COW_PATH(default) = None
ANSIBLE_COW_SELECTION(default) = default
ANSIBLE_COW_WHITELIST(default) = ['bud-frogs', 'bunny', 'cheese', 'daemon', 'default', 'dragon', 'elephant-in-snake', 'el
ANSIBLE_FORCE_COLOR(default) = False
ANSIBLE_NOCOLOR(default) = False
ANSIBLE_NOCOWS(default) = False
ANSIBLE_PIPELINING(default) = False
ANSIBLE_SSH_ARGS(default) = -C -o ControlMaster=auto -o ControlPersist=60s
ANSIBLE_SSH_CONTROL_PATH(default) = None
ANSIBLE_SSH_CONTROL_PATH_DIR(default) = ~/.ansible/cp
ANSIBLE_SSH_EXECUTABLE(default) = ssh
ANSIBLE_SSH_RETRIES(default) = 0
ANY_ERRORS_FATAL(default) = False
...
```

- 설정 가능한 모든 설정 항목 확인
```
vagrant@ansi-master1:~/ansitest
$ ansible-config list
ACTION_WARNINGS:
  default: true
  description: [By default Ansible will issue a warning when received from a task
      action (module or action plugin), These warnings can be silenced by adjusting
      this setting to False.]
  env:
  - {name: ANSIBLE_ACTION_WARNINGS}
  ini:
  - {key: action_warnings, section: defaults}
  name: Toggle action warnings
  type: boolean
  version_added: '2.5'
AGNOSTIC_BECOME_PROMPT:
  default: true
  description: Display an agnostic become prompt instead of displaying a prompt containing
    the command line supplied become method
  env:
  - {name: ANSIBLE_AGNOSTIC_BECOME_PROMPT}
  ini:
  - {key: agnostic_become_prompt, section: privilege_escalation}
  name: Display an agnostic become prompt
...
```

## 실습
- `/home/vagrant/ansitest/ansible.cfg` 에 아래 내용을 추가한다.
```
[defaults]
inventory      = /home/vagrant/ansitest/inventory


[privilege_escalation]
become=True
become_method=sudo
become_user=root
become_ask_pass=False
```

```
vagrant@ansi-master1:~/ansitest
$ ansible-config view
[defaults]
inventory      = /home/vagrant/ansitest/inventory


[privilege_escalation]
become=True
become_method=sudo
become_user=root
become_ask_pass=False
```

# 인벤토리
## 인벤토리
- Ansible은 인프라에 존재하는 여러 호스트를 관리한다.
- 호스트의 목록 또는 그룹을 지정한 인벤토리 파일이 필요하며 인벤토리가 정의되면 패턴을 사용하여 Ansible을 실행할 노드 또는 그룹을 선택한다.
- 기본 인벤토리 파일은 `/etc/ansible/hosts` 이며, -i 옵션을 사용하여 다른 인벤토리 파일을 지정할 수 있다.
- 인벤토리 파일은 일반적으로 INI 파일을 가지고 있으며 ,YAML 형식으로 지정할 수 있다.

## 정적 인벤토리
- 사용자가 직접 INI 또는 YAML 형식으로 파일을 직접 작성
![](images/Pasted%20image%2020230130143440.png)

## 기본 그룹
- all: 모든 호스트 포함
- ungrouped: 그룹에 속하지 않은 모든 호스트 포함

## 여러 그룹에 속한 호스트
- 각 호스트는 하나 이상의 그룹에 속할 수 있다.
- 중첩 그룹을 이용한 인벤토리 단순화

## 그룹화
![](images/Pasted%20image%2020230130143501.png)

## 중첩 그룹
![](images/Pasted%20image%2020230130143522.png)

## 호스트 범위
### 순차적인 호스트 그룹화
![](images/Pasted%20image%2020230130143625.png)

![](images/Pasted%20image%2020230130143634.png)
![](images/Pasted%20image%2020230130143648.png)

## 동적 인벤토리
- 가상화, 클라우드 및 컨테이너 환경과 같이 시간이 지남에 따라 관리 노드의 변화가 많은 경우에 사용
- 클라우드 공급자, LDAP 및 CMDB 등 동적 외부 인벤토리 시스템에서 호스트의 목록을 동적으로 가져올 수 있다.
- 연결 방법
	- 인벤토리 플러그인
	- 인벤토리 스크립트
	- AWS에서 연결 방법을 사용하기 위해서는 파이썬용 AWS SDK boto 패키지를 설치해야한다.

## 인벤토리 확인
- ansible 또는 ansible-inventory 명령으로 확인할 수 있다.

```
$ ansible all --list-hosts
  hosts (4):
    ansi-master1
    ansi-node1
    ansi-node3
    ansi-node2

$ ansible ungrouped --list-hosts
  hosts (1):
    ansi-master1

$ ansible AA --list-hosts
  hosts (2):
    ansi-node1
    ansi-node2

$ ansible ABC --list-hosts
  hosts (3):
    ansi-node1
    ansi-node2
    ansi-node3
```

```
$ ansible-inventory --list
{
    "AA": {
        "hosts": [
            "ansi-node1", 
            "ansi-node2"
        ]
    }, 
    "ABC": {
        "children": [
            "AA", 
            "BB"
        ]
    }, 
    "BB": {
        "hosts": [
            "ansi-node2", 
            "ansi-node3"
        ]
    }, 
    "CC": {
        "hosts": [
            "ansi-node1", 
            "ansi-node3"
        ]
    }, 
    "_meta": {
        "hostvars": {}
    }, 
    "all": {
        "children": [
            "ABC", 
            "CC", 
            "ungrouped"
        ]
    }, 
    "ungrouped": {
        "hosts": [
            "ansi-master1"
        ]
    }
}
```

## 패턴
- Ad-hoc 명령 또는 플레이북을 실행할 때 작업을 실행할 관리 노드 또는 그룹을 지정할 때 패턴을 이용해 관리 노드를 선택
- 패턴은 단일 호스트, IP 주소, 인벤토리 그룹을 참조할 수 있고, 집합, 와일드카드, 정규화 표현식 등 사용이 가능하다.

### 일반적인 패턴
| 대상        | 패턴                        |
| ----------- | --------------------------- |
| 모든 호스트 | all 또는 **                 |
| 단일 호스트 | host1                       |
| 여러 호스트 | hos1:host2 또는 host1,host2 |
| 단일 그룹   | webservers                  |
| 여러 그룹   | webservers:dbservers        |
| 제외 그룹   | webservers:!west            |
| 교차 그룹   | webservers:&east            | 

- 여러 패턴 혼합
```
webservers:dbservers:&east:!west
```
- 와일드 카드 패턴
- 정규 표현식 패턴

