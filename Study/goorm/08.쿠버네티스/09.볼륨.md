컨테이너는 이미지를 실행하는 것이지 그 안에 데이터를 저장하지 않는다. 파드에서도 마찬가지이다. 따라서 immutable infra라고 부르는 것이다. 하지만 운영체제가 있다면 처음과 끝이 같을 수가 없다. 예를 들면, 로그도 로컬에 남을 것이며 패키지 업데이트도 로컬에 남을 것이다. 따라서 이러한 불변의 인프라를 물리 컴퓨터나 VM에 만들기는 어렵다. 그래서 컨테이너를 불변의 인프라로 사용하는 것이다. 

컨테이너는 기본적으로 상태가 없는 앱 컨테이너를 사용한다. 상태가 없다는 것은 컨테이너에 문제가 있거나, 노드에 장애가 발생해서 컨테이너를 새로 실행했을 때 다른 노드로 자유롭게 옮길 수 있다는 뜻이다. 이것이 컨테이너의 장점이다. 하지만 데이터가 저장되지 않기 때문에 데이터를 따로 관리해야할 필요가 있다. 이러한 상황에서 볼륨을 사용하게 된다. 볼륨을 사용하면 컨테이너를 재시작하더라도 데이터를 유지한다. 

컨테이너와 볼륨을 분리시킨것, EC2 인스턴스와 EBS를 분리시킨 것 이 바로 이러한 이유에서이다. 컨테이너의 라이프 사이클과 데이터의 라이프 사이클을 분리하여 효율적으로 관리할 수 있게 하는 것이다.

쿠버네티스에서 사용할 수 있는 볼륨 플러그인들은 다양하다.

`pod.spec` 에는 어떤 컨테이너를 사용할지에 대한 내용을 작성하게 된다. 이 때 어떤 볼륨을 쓸 지도 지정해줄 수 있고 이는 `pod.spec.volumes` 에서 지정해 줄 수 있다.
`pod.spec.volumes[*].name` 은 필수로 작성해줘야 하고 `pod.spec.containers.volumeMounts`에 어떤 볼륨을 어디에 마운트할 것인지 지정해줘야한다. 

## emptyDir
emptyDir은 임시 디렉토리를 파드의 라이프타임동안 공유한다. 원래 볼륨은 파드의 라이프사이클과 분리하기 위한 것이지만 이 볼륨은 예외적으로 볼륨이 파드의 라이프사이클과 함께한다. 쿠버네티스는 파드가 생성되는 노드에 임시 디렉토리를 만들어주고 이를 볼륨으로 사용하게 하는 것이다.
`pod.spec.volumes.medium`이 기본값일 경우 해당 노드에 임시 디렉토리를 만들어준다. Memory를 사용하는 경우에는 메모리 디스크를 사용한다. 리눅스의 `df -hT` 의 타입을 확인해봤을 때 메모리를 사용하는 특수한 파일시스템들을 확인할 수 있다. (tmpfs 등)  빠른 속도가 필요한 경우에 사용한다. 
```
KIND:     Pod
VERSION:  v1

RESOURCE: emptyDir <Object>

DESCRIPTION:
     emptyDir represents a temporary directory that shares a pod's lifetime.
     More info: https://kubernetes.io/docs/concepts/storage/volumes#emptydir

     Represents an empty directory for a pod. Empty directory volumes support
     ownership management and SELinux relabeling.

FIELDS:
   medium       <string>
     medium represents what type of storage medium should back this directory.
     The default is "" which means to use the node's default medium. Must be an
     empty string (default) or Memory. More info:
     https://kubernetes.io/docs/concepts/storage/volumes#emptydir

   sizeLimit    <string>
     sizeLimit is the total amount of local storage required for this EmptyDir
     volume. The size limit is also applicable for memory medium. The maximum
     usage on memory medium EmptyDir would be the minimum value between the
     SizeLimit specified here and the sum of memory limits of all containers in
     a pod. The default is nil which means that the limit is undefined. More
     info: http://kubernetes.io/docs/user-guide/volumes#emptydir
```

### 예시
```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: myapp-rs-fortune
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myapp-rs-fortune
  template:
    metadata:
      labels:
        app: myapp-rs-fortune
    spec:
      containers:
      - name: web-server
        image: nginx:alpine
        volumeMounts:
        - name: web-fortune
          mountPath: /usr/share/nginx/html
          readOnly: true
        ports:
        - containerPort: 80
      - name: html-generator
        image: ghcr.io/c1t1d0s7/fortune
        volumeMounts:
        - name: web-fortune
          mountPath: /var/htdocs
      volumes:
      - name: web-fortune
        emptyDir: {}
```
이 예시에서는 주 역할을 하는 `web-server` 와 보조 역할을 하는 `html-generator`가 있다. 똑같은 볼륨을 컨테이너 각각에 다른 위치에 마운트를 한다. 이렇게 하는 경우 `html-generator` 에서 생성하는 html을 `web-server`가 제공할 수 있게 되는 것이다. 

emptyDir은 같은 파드 내에 여러 컨테이너들이 같은 스토리지를 공유해야하는 경우에 사용한다. 네트워크를 사용하는 경우는 너무 오버헤드가 크기 때문에 좋지 않다. 

### gitRepo
깃으로 저장소를 동기화하여 제공하는 경우는 매우 많다. 하지만 쿠버네티스에서 이를 제공하는 gitRepo는 deprecated 된다. 쿠버네티스에서는 그 대안으로 InitContainer를 사용하는 것을 제안한다.
```
vagrant@kube-control1:~$ kubectl explain pod.spec.volumes.gitRepo
KIND:     Pod
VERSION:  v1

RESOURCE: gitRepo <Object>

DESCRIPTION:
     gitRepo represents a git repository at a particular revision. DEPRECATED:
     GitRepo is deprecated. To provision a container with a git repo, mount an
     EmptyDir into an InitContainer that clones the repo using git, then mount
     the EmptyDir into the Pod's container.

     Represents a volume that is populated with the contents of a git
     repository. Git repo volumes do not support ownership management. Git repo
     volumes support SELinux relabeling.

     DEPRECATED: GitRepo is deprecated. To provision a container with a git
     repo, mount an EmptyDir into an InitContainer that clones the repo using
     git, then mount the EmptyDir into the Pod's container.
```

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: myapp-pod-git
spec:
  initContainers:
    - name: git-clone
      image: alpine/git
      args:
        - clone
        - --single-branch
        - --
        - https://github.com/kubernetes/kubernetes
        - /repo
      volumeMounts:
        - name: git-repository
          mountPath: /repo
  containers:
    - name: git-container
      image: busybox
      args: ['tail', '-f', '/dev/null']
      volumeMounts:
        - name: git-repository
          mountPath: /repo
  volumes:
    - name: git-repository
      emptyDir: {}
```

### 초기화 컨테이너
initContainers의 경우에는 보조역할을 하는 컨테이너이다. 이 컨테이너는 무조건 종료되어야 하는데 그 이유는 파드가 생성되면 항상 containers보다 먼저 실행되며 이후 종료되어야 containers가 시작되기 때문이다. 
initContainers는 종료가 보장되어야 하기 때문에 probe를 사용할 수 없다. 

## 