# VPN
- Virtual Private Network
- 큰 큐모의 조직의 네트워크가 분산되어 있을 경우 각 네트워크를 연결
- 암호화 기수릉ㄹ 적용하여 보안을 강화
- 클라우드와 온프레미스 간 연결을 통해 보안을 강화한 하이브리드 클라우드 구축
기존 IDC에서 서비스하던 모든 시스템을 클라우드로 이전하는 것은 매우 어려운 일이다. IDC - 클라우드 간의 네트워크 연결을 통해 기존 시스템과 클라우드 시스템 간의 데이터 통신이 필요하게 된다. AWS VPC와 VPC Gateway를 통해 온프레미스의 VPN 장비와 AWS 간의 VPN을 연결할 수 있다.

# VPC(Virtual Private Cloud)
- AWS 클라우드에서 논리적으로 격리된 네트워크 공간을 할당하여 가상 네트워크에서 AWS 리소스를 이용할 수 있는 서비스를 제공
- Amazon VPC 자체 IP 주소 범위, 서브넷 생성, 라우팅 테이블 및 네트워크 구성선택 등 네트워킹 환경을 완벽하게 제어
- 보안 그룹(Security Group) 및 네트워크 제어 목록(Network Access Control List)을 포함한 다중 보안 계층을 활용하여 각 서브넷에서 EC2 인스턴스에 대한 액세스 제어 가능
- 데이터 센터와 VPC 사이에 하드웨어 가상 사설 네트워크 연결을 생성하여, AWS 클라우드를 마치 기업의 데이터 센터를 확장한 것 처럼 사용할 수 있다.

| 구분      | 내용                                                                                                                                                                                                                                                                                                  |
| --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 서비스 명 | Aamzon VPC                                                                                                                                                                                                                                                                                            |
| 설명      | 직접 정의 가능한 가상 네트워크에서 AWS 리소스를 구동할 수 있는 논리적으로 격리된 네트워크 제공                                                                                                                                                                                                        |
| 주요 특징 | - AWS에 사설 네트워크 구축<br>- 회사와 AWS간 VPN을 연결하거나 가상 네트워킹 구현<br>- 기존 데이터 센터와의 연결을 통해 하이브리드 환경 구성<br>- AWS를 회사 인프라의 일부처럼 사용할 수 있으며, 내부 시스템 소프트웨어의 연동이 매우 쉬움<br>- 세심한 네트워크 설정 가능<br>- 모든 리전에서 이용 가능 |
| 프리티어  | VPC 자체는 비용이 발생하지 않지만, VPN 연결 시 네트워크 송/수신에 따른 종량제 비용 발생                                                                                                                                                                                                                                                                                                      |

# VPC의 구성 요소
## Private IP, Public IP, Elastic IP
### Private IP
- 프라이빗 IP는 인터넷을 통해 연결할 수 없는 VPC 내부에서만 사용할 수 있는 IP 주소이다. 
- VPC 에서 시작된 인스턴스 서브넷 범위에서 자동으로 할당
- 동일 네트워크에서 인스턴스간 통신에 사용 가능
- 보조 프라이빗 IP 주소라는 추가 프라이빗 주소 할당 가능

### Public IP
- 인터넷을 통해 연결가능한 IP
- 인스턴스에서 퍼블릭 IP 주소를 수동으로 연결하거나 해제 불가능
- 인스턴스가 재부팅 되면 새로운 퍼블릭 IP 할당

### Elastic IP
- 동적 컴퓨팅을 위해 고안된 고정 퍼블릭 IP
- VPC의 모든 인스턴스와 네트워크 인터페이스에 탄성 IP를 할당 가능 
- 다른 인스턴스에 주소를 다시 매칭하여 인스턴스 장애 조치 수행 가능
- 사용 가능한 탄력적 IP 주소는 5개로 제한되며, 이를 절약하기 위하여 NAT 디바이스 사용 가능

## VPC와 서브넷
- VPC는 사용자의 AWS 계정을 위한 전용의 가상 네트워크를 의미
- VPC 내부의 네트워크에서도 서비스 목적에 따라 IP Block으로 나누어 구분할 수 있다. 이렇게 분리된 IP Block의 모음을 서브넷이라고 한다.
- VPC는 리전의 모든 가용영역에 적용되며 각 가용영역에 하나 이상의 서브넷을 추가할 수 있다. 단 단일 가용영역에서만 생성할 수 있고 여러 가용 영역으로 확장 불가능

## VPC와 서브넷의 사이즈
- VPC를 생성할 때 VPC에서 사용하게 될 IP 주소의 범위를 CIDR(Classless Inter-Domain Routing) 블록 형태로 지정

## Public Subnet 과 Private Subnet
- 퍼블릭 서브넷: 서브넷 네트워크  트래픽이 인터넷 게이트웨이(Internet Gateway, IGW)로 라우팅 되는 서브넷
- 프라이빗 서브넷: 인터넷 게이트웨이로 라우팅되지 않는 서브넷
- 일반적으로 웹 서버는 퍼블릭 서브넷에 생성하며 인터넷에 직접적으로 연결할 필요가 없고 높은 보안성을 요구하는 DB등은 프라이빗 서브넷에 생성한다.

## 라우팅 테이블(Routing Table)
- 각 서브넷은 서브넷 외부로 나가는 아웃바운드 트래픽에 대해 허용된 경로를 지정하는 라우팅 테이블이 연결되어있어야 한다.
- 생성된 서브넷은 자동으로 VPC의 기본 라우팅 테이블과 연결, 테이블 내용 수정 가능
- 서브넷 간의 통신이나 VPC 간의 통신을 위해 라우팅 테이블을 사용

# VPC 주요 서비스
## Security Group 과 Network ACL
VPC는 네트워크 통신과 트래픽에 대해 IP와 Port를 기준으로 통신을 허용하거나 차단하기 위한 기능을 제공
VPC의 보안그룹과 네트워크 ACL을 통해 방화벽과 동일한 기능을 사용할 수 있다.

| 구분         | 보안 그룹                         | 네트워크 ACL                       |
| ------------ | --------------------------------- | ---------------------------------- |
| 서비스 범위  | 인스턴스 레벨에 적용              | 서브넷 레벨에 적용                 |
| 적용 정책    | 허용 규칙만 적용                  | 허용 및 거부 규칙 적용             |
| 구동 방식    | 규칙에 상관 없이 반환 트래픽 허용 | 반환 트래픽이 별도로 허용되어야함  |
| 룰 검토/적용 | 해당 객체 내 모든 룰 검토         | 해당 객체 내 룰을 번호 순으로 처리 |
| 적용 방법    | 인스턴스에 보안 그룹 추가 필요    | 연결된 서브넷의 모든 인스턴스에 자동 적용됨                                   |

## VPC Peering Connection
- 피어링 연결은 비공개적으로 두 VPC 간에 트래픽을 라우팅할 수 있게 하기 위한 서로 다른 VPC 간의 네트워크 연결을 제공, VPC Peering 을 통해 동일한 네트워크에 속한 것과 같이 서로 다른 VPC 인스턴스 간 통신이 가능

## NAT(Network Address Translation)게이트웨이
- NAT는 외부 네트워크에 알려진것과 다른 IP 주소를 사용하는 내부 네트워크에서, 내부 IP 주소를 외부 IP 주소로 변환하는 작업을 수행하는 서비스이다.
- NAT 게이트웨이는 프라이빗 서브넷 내에 있는 인스턴스를 인터넷 또는 다른 AWS 서비스에 연결하고 외부망 또는 인터넷에서 해당 인스턴스에 연결하지 못하도록 구성하는데 사용
- NAT 게이트웨이를 구성하기 위해  다음 세 가지 조건을 만족해야함
	- NAT 게이트를 생성하기 위해 퍼블릭 서브넷을 지정
	- NAT 게이트웨이와 연결할 탄력적 IP 주소 필요
	- NAT 게이트웨이를 만든 후 인터넷 트래픽이 NAT 게이트웨이로 통신이 가능하도록 프라이빗 서브넷과 연결된 라우팅 테이블 업데이트
- NAT 인스턴스로 대체 가능

## VPC Endpoint
- Amazon S3는 인터넷망에 연결된 서비스로 인터넷 기반의 IP 주소와 연결정보를 가지고 있다.
- 공용 리소스에 대해 퍼블릭 서브넷에 위치한 인스턴스는 인터넷을 통해 연결이 가능하지만 프라이빗 서브넷에 위치한 인스턴스는 인터넷에 연결되어 있는 S3와 같은 공용 리소스를 연결할 수 없다.
- 이를 위해서 NAT 게이트웨이나 NAT 인스턴스가 필요하지만 VPC Endpoint를 이용하면 빠르고 쉽게 S3, DynamoDB 등에 연결할 수 있다.
- VPC Endpoint 유형
	- Gateway Endpoint
	- Interface Endpoint

## VPN 연결
- 기본적으로 VPC에서 서비스되는 인스턴스는 온프레미스의 서버나 IDC 내의 시스템과 통신 불가능
- VPC내 인스턴스와 IDC 내 시스템 간의 데이터 통신을 위해 VPC에 가상의 프라이빗 게이트웨이를 연결하고 사용자 지정 라우팅 테이블을 생성, 보안 그룹의 규칙 업데이트, AWS 관리형 VPN 연겨을 생성하여 VPC에서 원격의 네트워크에 접속 가능
- VPN 연결은 VPC와 자체 네트워크 사이의 연결을 의미

# 실습
## VPC 생성 순서
1. VPC 생성(네트워크에서 사용할 IP 구간 설정)
2. 서브넷 생성(설정된 IP 구간을 세부적으로 설정)
3. 인터넷 게이트웨이 생성 및 VPC 연결
4. 라우팅 테이블 생성 및 작성(퍼블릭/프라이빗 서브넷 설정)
프라이빗 서브넷이 외부와 소통해야하는 경우
5. NAT 게이트웨이 생성(프라이빗 서브넷에 속한 인스턴스가 인터넷을 필요로 하는 경우)
6. 라우팅 테이블 수정

![](images/Pasted%20image%2020230126141952.png)

## VPC를 통해서 퍼블릭 서브넷과 프라이빗 서브넷 만들기
1. VPC -> VPC 생성
	- VPC 등으로 선택하는 경우 그 아래 부분까지 모두 동시에 만들게 된다.
	- CIDR은 16부터 된다.
		- 고가용성을 위해서 가용영역 수를 2개 이상으로 설정가능하다.
	- 퍼블릭, 프라이빗 서브넷 수를 지정한다.
2. VPC 보기
	- VPC 생성하는 순간 기본 라우팅 테이블이 작성된다.
		- 해당 VPC에 속한 인스턴스들은 서로 통신이 가능하도록 라우팅 테이블이 생성된다.
	- 퍼블릭 라우팅 테이블의 경우 10.0.0.0/16 에 대한 것은 local, 0.0.0.0/0에 대한 것은 인터넷 게이트 웨이에 연결되어 있는 것을 확인할 수 있다.
		- 명시적 서브넷에서 퍼블릭 서브넷들이 이곳에 속하는 것을 확인할 수 있다.
3. 퍼블릭과 프라이빗에 맞는 인스턴스 생성해서 확인해보기
	- VPC, 서브넷 등을 선택

### VPC만 생성
1. VPC만 생성
2. 서브넷 에서 서브넷 생성
3. 인터넷 게이트웨이 생성 및 연결
4. 라우팅 테이블 생성 및 연결
	- pub용, prv용 생성
	- 라우팅 테이블에 라우팅 설정 및 서브넷 연결
		- 명시하지 않는 서브넷의 경우 default 라우팅 테이블의 영향을 받는다. 
5. NAT 게이트웨이 생성
	- 서브넷은 public으로 선택
	- 탄력적 IP 선택 혹은 할당
	- 라우팅 테이블 -> private라우팅테이블에서 외부에 대해 NAT 게이트웨이로 가도록 라우팅 테이블 업데이트
	- 라우팅 테이블에 private 서브넷 연결
	- 해당 서브넷만 외부에 연결 되는 것 확인 가능
```
[ec2-user@ip-100-0-100-48 ~]$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=104 time=18.1 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=104 time=17.7 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=104 time=17.8 ms
64 bytes from 8.8.8.8: icmp_seq=4 ttl=104 time=17.6 ms
^C
--- 8.8.8.8 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3005ms

[ec2-user@ip-100-0-110-199 ~]$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
^C
--- 8.8.8.8 ping statistics ---
4 packets transmitted, 0 received, 100% packet loss, time 3073ms
```

### VPC 삭제 순서
1. 인스턴스 삭제
2. NAT 게이트웨이 있는 경우 NAT 게이트웨이 삭제
	- 탄력적 IP 릴리스


## VPC 피어링
1. 다른 리전 VPC 피어링 인터페이스 생성 및 연결 신청
2. 반대쪽 VPC에서 연결 수락
3. 양쪽 VPC에서 라우팅 테이블 수정
다른 리전에 프라이빗 서브넷만 가지는 인스턴스 생성후 VPC 피어링한 다음 통신해보면 되는 것을 확인 가능하다.

# 참고
- https://www.uturndata.com/2021/02/23/aws-quick-tips-internet-gateways-nat-gateways-and-nat-instances/
- https://medium.com/harrythegreat/aws-%EA%B0%80%EC%9E%A5%EC%89%BD%EA%B2%8C-vpc-%EA%B0%9C%EB%85%90%EC%9E%A1%EA%B8%B0-71eef95a7098
- https://sharplee7.tistory.com/125

## Internet GateWay, NAT Gateway, NAT Instatnce
### Public Subnet
퍼블릭 서브넷은 인터넷 게이트웨이로 가는 라우트를 가진 서브넷을 말한다. 인터넷을 통해 밖으로 나가야하는 트래픽과 서브넷 안에 있는 서비스들로 들어오는 인바운드 인터넷 트래픽을 허용한다. 
## Internet Gateway
- VPC와 인터넷사이의 통신을 가능하게하는 VPC의 구성요소다.
- horizontally scaled, redundant, and highly available
- 네트워크 가장자리에 있는 라우터와 같다. 퍼블릭 IP가 있더라도 인터넷 게이트웨이 없이 VPC는 인터넷에 접근할 수 없다. 
- VPC하나에 하나의 인터넷 게이트웨이만 할당할 수 있다.
### Private Subnet
- 프라이빗 서브넷은 인터넷 게이트웨이로 라우팅 되지 않는 모든 서브넷이다. 
- 따라서 인터넷에 연결할 수단이 없다. 
### NAT Gateway
- 프라이빗 서브넷이 인터넷에 접근할 수 있게하지만 인터넷이 인스턴스에 직접적으로 연결을 시도하는 것을 막는다.
- 프라이빗 서브넷이 인터넷 연결을 할 수 있게 하는 것이지만 퍼블릭 서브넷 안에 생성된다.
- 프라이빗 서브넷에서 인터넷 게이트웨이 대신에 NAT 게이트웨이를 라우팅한다. 흐름은 프라이빗 서브넷에서 퍼블릭 서브넷 안에 있는 NAT 게이트웨이로, 그리고 인터넷 게이트웨이를 통해서 인터넷으로 가게된다.
### NAT Instance
- NAT 인스턴스는 AWS에서 제공하는 서비스가 아니라, NAT 게이트웨이 처럼 동작하는 EC2를 사용할 때를 위한 용어이다.
- 라우팅 구성, 소프트웨어와 OS 업데이트, 인스턴스 사이즈 등이 사용자에게 달려있다.
- 특별한 use-case가 있지 않는 이상 추천되지 않는다.

