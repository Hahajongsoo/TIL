# AWS Building Block
aws 상에서 구축할 수 있는 개발환경에 대한 기초부터 배포, 운영, 모니터링까지 구현할 수 있도록 구성된 개발자 커뮤니티

# DevOps
개발과 운영을 긴밀하게 연결하여 개발 사이클을 빠르게 끌어 올리는 것을 의미한다. 개발을 빠르게 진행하고 배포, 운영을 안정적으로 하게 된다. 하지만 개발과 운영의 초점이 다르기 때문에 이를 긴밀하게 연결하는 것이 어려운 경우가 있다. (새로운 기능, 속도 그리고 안정적 운영 및 배포)
## 소프트웨어 개발 생명 주기
개발자: 계획, 코드 빌드
QA 테스트
운영: 릴리즈 배포 운영 모니터링
- 각 개발팀, QA팀, 운영팀이 나눠져있기 때문에 빠른 피드백 및 다음 단계로 넘어가는 것이 어려울 수 있다. 
	- 예를 들어 개발에서 패치 > QA에서 테스트 > 운영에서 서버를 내리고 업데이트까지 대기
	- 이러한 의사소통과 각 단계에서 기다림이 있기 때문에 전체 사이클이 오래걸릴 수 밖에 없게 되는 것이다.
	- DevOps를 통해서 이 각 단계의 작업들을 자동화해야한다.

## DevOps를 어렵게 하는 것
- 시작하기가 어렵다.
	- DevOps를 위한 툴들이 너무 많다.
	- 너무 많은 서비스를 결합해야한다. 또한 웹 UI, 사이트로 접근할 수 있게 해놓아야한다.
		- CI/CD
		- 보안
		- 모니터링 ...
	- 중앙집중형 관리가 필요하다.
- DevOps에 대한 오해

### 문화 철학
각 기업은 해당 기업이 살아남기 유리한 문화, 철학으로 되어 있을 수 밖에 없다. 데브옵스를 적용하기 위해서는 조직의 문화를 데브옵스에 유리한 문화로 바꿔야한다.
- 수평적인 조직 구성
- 빠른 실패
	- 코드 리뷰를 잘하는 문화가 정착되어 있어야 좀 더 빠르게 에러를 확인할 수 있다. 이는 수평적인 조직 구성과도 어느정도 연결되어 있다. (시니어의 코드를 주니어가 리뷰)
	- 더 저렴한 실패를 빠르게 확인할 수 있기 때문에 더 심각한 오류를 예방할 수 있게 된다.
- 자유로운 정보 공유
	- 각 팀들이 사일로화되어 있는 경우, 팀들에서 나오는 데이터가 다를 수 있고 각 데이터들을 따로 보는 경우 전체적으로 데이터를 모아놓고 보는 경우에서 얻을 수 있는 인사이트를 얻지 못할 수 있다. 
- 문화를 바꾸는 것은 모두가 참여해야한다. 문화를 바꾸는 가장 빠른 방법은 리더쉽팀이 참여하는 것이다.

## Devops
### 배포 자동화
## AWS Service for Developer Tools

![](images/Pasted%20image%2020230418133407.png)

### 모니터링과 관찰가능성(Observability)
Overvability는 어플리케이션에서의 output을 가지고 어플리케이션의 상태를 역으로 추론할 수 있는 것을 의미한다.
#### 데이터기반의사결정
실시간 데이터로 실시간 의사 결정
- 로그
- 메트릭
- 트레이스
![](images/Pasted%20image%2020230418133754.png)

아래처럼 AWS 툴 만 사용할 수도 있으나 오픈소스들과 결합하여 (프로메테우스, 그라파나, 예거 등) 사용할 수도 있다. 
![](images/Pasted%20image%2020230418133949.png)

ADOT(AWS Distro for OpenTelemetry)

### 운영 자동화
코드형 인프라, Infra as a Code
- 선언형 인프라
	- AWS Cloud Development Kit
	- AWS CloudFormation
- 명령형 인프라
	- AWS Command Line Interface
	- Copilot CLI
코드형 인프라의 가장 큰 장점은 인프라 개발 주기를 소프트웨어 개발주기와 동일한 단계로 사용가능하다. 소프트웨어와 동일한 형태의 개발방법론을 적용할 수 있다.

#### 코드 저장소의 변화
애플리케이션코드와 인프라코드를 같은 레포지토리에서 관리하게 되는 경우, 가장 큰 장점은 인프라와 애플리케이션의 버전을 동일하게 가져갈 수 있다는 것이다. 

#### 테스트 환경 관리
프로덕선 환경, 스테이지 환경, 피처 환경들을 각각 코드로 관리해서 잠깐 생성한 후에 다시 삭제할 수 있게 된다.

![](images/Pasted%20image%2020230418134828.png)

### 보안
보안을 보안 팀에서 모두 관리하는 것은 힘들기 때문에 DevOps 파이프라인에서 같이 테스트하는 것이 DevSecOps이다. 
파이프라인의 보안, 파이프라인 안의 보안이 있다.

# CI/CD on AWS
CI: 협업을 할 때 피쳐 브랜치를 주기적으로 메인 브랜치와 통합하면서 코드의 테스트를 한 번에 하는 부담을 줄일 수 있게 된다.
CD: Approve가 필요하냐 아니냐에 따라서 continuous delivery 와 deployment로 나뉠 뿐, 기술적인 차이는 없다. 

## 지속적 통합
- 중앙 저장소로의 통합
- 자동화 된 테스트를 통한 품질 검증(코드의 테스트, 린트 등)
- 코드리뷰를 통한 개발 문화 활성화
	- 팀원에게 태클을 걸거나 태클을 받게 되어 불쾌하게 여겨질 수 도 있다. 하지만 이전에 빠른 실패를 위해 필요하다.
	- 코드 리뷰를 통해서 모든 팀원들이 업데이트 방향을 따라갈 수 있다는 것에도 장점이 있다.
- 개발자에게 직접적인 피드백

### AWS CodeCommit

## 지속적 배포 및 전달
- 코드 변경하상을 자동으로 반영
- 빌드 후 테스트/프로덕션 환경에 변경사항을 배포
- 애플리케이션이 더욱 견고해짐
- 빠르게 실패하고, 빠르게 롤백
- 표준화 된 테스트 프로세스를 통과한 빌드 아티팩트가 생성

### AWS CodeBuild
- 소스코드를 컴파일하는 단계부터 테스트 실행후, 소프트웨어 패키지를 개발하여 배포하는 단계까지 마칠 수 있는 완전 관리형 빌드 서비스
- 빌드 볼륨에 따라 자동으로 확장 및 축소
- 빌드를 완료할 때 까지 걸리는 시간 별로 과금

### AWS CodeDeploy
- 코드 배포를 자동화하는 완견 관리형 배포 서비스
- 복잡한 애플리케이션 업데이트 작업을 처리
- 배포 중, 다운타임 최소화, 오류감지시 자동으로 롤백
- AWS EC2, Lambda, ECR, 로컬 등에 자동으로 배포

## CI/CD 를 통해
- Application과 Infastructure의 최신상태를 유지
	- IaaC를 사용해야한다.
- Wokrflow 시각화
	- 말로 설명하는 것보다 파이프라인을 눈으로 보여주는 것이 더 명확하게 내용을 전달할 수 있다. 
- 다른 Pipeline을 제어
	- 트리거링
- 각 단계에 따른 Log를 분석하여 배포 프로세스 디버깅
- 공용 환경에서의 일관성 있는 빌드/배포
- "배포담당자"의 실종
	- CI/CD를 통한 가장 궁극적인 생산성 증가

### CI/CD Pipeline 구성
- 빌드 및 배포의 단계를 나누어 구성
- 각 단계는,
	- 병렬 수행 가능
	- 전 단계 성공시 수행
	- Pipeline이 실패할 수 있음을 고려
- 빌드에 필요한 Container Image를 찾거나, 제작

### CI/CD Pipeline 실행
- Git Branch에 Push가 발생했을 때
- Pull/Merge Request가 승인됐을 때
- 수동 실행(API, Web Console)
- 스케쥴 기반
- 패키지 파일 또는 컨테이너 이미지가 제작됐을 때

## CI/CD 파이프라인

![](images/Pasted%20image%2020230418144416.png)

![](images/Pasted%20image%2020230418144528.png)

![](images/Pasted%20image%2020230418144541.png)

### AWS CodePipeline
- 빠르고 안정적인 애플리케이션 업데이트를 위한 지속적인 제공 서비스
- 소프트웨어 릴리스 프로세스 모델링 및 시각화
- 코드가 변경될 때마다 코드를 빌드, 테스트 및 배포
- 타사 도구 및 AWS와 통합

# DevSecOps 환경에서의 보안과 보안서비스
## DevSecOps 원칙
- 보안을 중심의 문화로서 접근
- 가능한 보안에 대한 검증을 이른 단계에 시작하여 피드백 속도를 가속화(DevOps 파이프라인에 적용)
- 지속적으로 모니터링하고, 탐지하고, 대응하고, 개선하는 프로세스를 생성
- 자동화하고 자동화하고 또 자동화

### DevSecOps 파이프라인 디자인 전략
- 모든 것을 자동화
- 조직의 보안 적합성 검사등을 포함
	- 나중에 한 번에 하는 것이 아니라 각 단계마다 적용하는 것을 추천
- 인프라로서의 파이프라인에 대한 위협 식별
- 배포 전략의 수립, 그 안에 보안을 적용
- 파이프라인내에 자동 원복 기능을 포함
- 비정상 상황을 선제적으로 식별하기 위해 관측가능성과 모니터링을 통해 강력한 피드백 루프를 구성
- 운영환경과 동일한 사전 운영환경 구성(dev, test, staging)
- 빌드 패키징에 무결성 체크 포함
- 디펜던시 취약점 검사를 포함
- 파이프라인 권한 및 역할에 대한 검토

## 활성화를 위한 주요 항목
- 모두가 보안 엔지니어라는 인식이 필요하다.
	- 빠른 비즈니스 개선도 필요하지만 개발자도 보안에 대한 인식을 가져야할 필요가 있다. 보안팀 또한 개발적 인식을 가지고 파이프라인에 관여해야한다.
- 공동 프로그래밍 작업
	- 개발은 어떤 보안을 적용해야하는지 보안은 우리나라의 비즈니스에서 어떤 기술이 포함되어야 하는지 등을 알아야 하므로 서로 의사소통이 필요하다.
- 지속적인 학습을 위한 적잘한 도구 선정
- Certification rules
- DevSecOps 신조에 맞는 인력 배치
- 무엇이 엔지니어와 개발자에게 동기를 부여하는지 파악

## Shift left란 무엇을 말하는 것인가
### Shift left
> Shife left는 소프트웨어 배포 프로세스에서 결함을 빠른 단계에서 식별하고 차단하기 위한 프랙티스를 말한다.

개발, 테스트, 운영 프로세스에서 개발 단계에 가까워지는 것을 shift left, 운영 단계에 가까워지는 것을 shift right로 보면 된다.

![](images/Pasted%20image%2020230418152359.png)

이상적인 것은 shift left를 하는 것이다. 빠르게 위협을 식별하고 빠르게 조치를 취하는 것이다. 시간과 비용을 모두 절약할 수 있는 방법이다. 오른쪽으로 간 상태에서 보안상의 위협, 코드상의 에러를 발견하는 경우 여기까지온데 들어간 비용을 다시 들어야하기 때문에 더 많은 시간과 비용이 들게 된다.

### AWS Code Guru
- 코드 검토후 조치 가능한 권고 제공
- 운영환경에서 필요한 성능/비용 개선항목 식별
- 빌드 및 테스트 단계에서 불필요한 코드 식별
- 주요 리포지토리 지원
- 아직 서울 리전에서는 지원되지 않는다.

### AWS Code Whisperer
- vscode등에 추가 설치해서 사용, 무료
- 실시간 코드 권고
- 익숙하지 않은 API/프레임워크를 손쉽게 사용
- 어플리케이션 보안 강화
- 레퍼런스 추적

### AWS Config 규칙
- AWS 리소스들의 형상(설정)을 추적 관리한다.
	- 특정 리전에만 EC2를 띄워야 한다.
	- EC2 의 스펙은 특정 스펙이어야 한다.
	- 특정 정보는 KMS와 연동해야 한다. 등
- 선제적 규칙 검사
- 배포 후 규칙 검사
- 자동 교정
- 사전 정의 템플릿 사용
- 고객 관리형 규칙 사용
- 상시 모니터링

### AWS Systems Manager
- AWS Config 에서는 AWS Systems Manager 의 Automation 기능을 이용하여 교정 기능 제공
- 규정을 위반하는 자원에 대한 수동 혹은 자동 교정을 선택 가능
- 사용자 정의 교정 규칙을 생성 가능

### AWS Secrets Manager
- Secrets 자동 교체
	- RDS 비밀번호를 자동으로 교체해준다. 사용자가 Secrets Manger API에 접근가능한 경우 해당 API에 접근해서 비밀번호를 내려받게 되고 해당 비밀번호를 이용하는 것이다. 즉 사용자는 비밀번호를 알 필요도 없고 관리할 필요도 없게된다. 
- 기본 암호화
- 무작위 Secret 생성 기능
- 사고 발생 시 피해 범위 최소화

### Amazon GuardDuty
- GuardDuty와 매칭되는 오픈소스나 상용 툴은 없다. 같은 기능을 사용하려면 여러 솔루션들을 엮어야 하기 때문에 배보다 배꼽이 더 큰 경우가 발생할 수 있게 됨
- 의심스러운 활동에 대한 탐지
- 호스트 및 OS 레벨의 활동 감지
- 파일 접근, 프로세스 실행, 네트워크 연결 감시
- **AWS 관리형 에이전트-EKS와 통합**

### Amazon Inspector
- 단순한 설정을 통한 자동 검사 기능 제공
- EC2 인스턴스, Container 이미지, Lambda
- 지속적인 자동 스캔
- 컨텍스트 기반 스코어링

### AWS cdk-nag
- 오픈소스 PaC 도구
- AWS CDK 어플리케이션 유효성 검증
- 모든 AWS CDK 설정 지원
- 사전 정의 규칙 제공(PCI DSS, NIST 800-53 등)

### AWS CFN-Guard
- 오픈소스 PaC 도구
- 규정 준수 검증을 위한 규칙 검사
- AWS CloudFormation 유효성 검증
- JSON 과 YAML 지원(테라폼 State, K8S)

### AWS CloudFormation Hook
- 선제적인 유효성 검증
- 보안 규정 자동 적용
- 조직에서 필요한 상황에 따라 작성

## CI/CD 파이프라인의(OF) 보안
CI/CD가 이루어지는 기반, 인프라의 보안을 의미한다. 코드, 이미지 등 산출물들이 저장되는 저장소들도 안전하게 저장되어 있어야하고 접근을 제한해야한다.
- 설정 관리
- 키 관리
- 암호화
- 인증 및 인가
- 패치
- 알람 및 모니터링
- 로깅 및 감사

### SLSA 프레임워크
Supply-chain Levels for Software Artifacts로, 구글이 주장하는 프레임워크이다. 각 단계에서의 위협을 방어하는지 확인한다.

![](images/Pasted%20image%2020230418155137.png)

#### 소스 무결성
- 위협
	- 미검토 변경 사항 제출
	- 코드 검토 요구 사항 회피
	- 코드 검토 우회
	- 소스 리파지토리 침해
- 방어
	- 모든 변경에 대한 two-person approval 매커니즘
	- 확인 후 변경 사항을 병합 위한 역할 사용
	- 모든 역할에 대한 동일한 통제 항목 준용
	- 이벤트 모니터링

##### 소스 무결성 유지 방안

![](images/Pasted%20image%2020230418155550.png)

소스 접근에 대한 권한 및 역할을 생성한다. 소스에 대한 이벤트를 꾸준히 모니터링하고 이벤트 발생시 알람을 생성한다.

#### 빌드 무결성
- 위협
	- 비공식 포크/브랜치에서의 빌드
	- 비공식적인 빌드 단계에서의 빌드
	- 비공식 엔트리포인트에서의 빌드
	- 변경된 버전에서의 빌드
	- 침해된 환경에서의 빌드
	- 침해된 디펜던시
	- 아티팩트에 대한 변조
	- 침해된 패키지
- 방어
	- 빌드를 위한 특정 브랜치 지정
	- 소스 위치  소유자에 대한 검증
	- 소유자 빌드 설정에 대해 특정 값을 매치하도록 요구
	- 신뢰하고 유효성이 검증된 리포지토리로부터의 빌드 사용
	- 환경에 대한 임시성 보장

##### 빌드 무결성 유지 방안

![](images/Pasted%20image%2020230418155806.png)

일회성 환경을 통해서 환경을 테스트한다. 이때 AWS Config를 사용하여 테스트 환경, 운영환경에 위반사항이 있는지 확인한다.

#### 가용성 및 기타 위협
- 위협
	- 코드 삭제
	- 디펜던시가 임시적으로나 영구적으로 불능
	- 정책에 대한 조작
	- 변경된 메타데이터에 대한 삭제
	- 암호화 해쉬에 대한 익스플로잇(극단적이긴 하나 base64, md5 등)
- 방어
	- 리비전 몇 버전 통제 이력에 대한 기록
	- 패키지 및 디펜던시에 대한 저장
	- 정책 리뷰에 대한 Two-Party 요구
	- 강력한 인증, 시간 및 상위 리비전 등 요구
	- 코드 검토 및 강력한 암호화 알고리즘 사용

### 소프트웨어 부품표(SBOM)
- 권장
	- 라이센스 정보
	- 구성요소 해쉬
	- 생명 주기
	- 기타 구성요소 관계
- 필수
	- 공급자 이름
	- 구성요소 이름
	- 구성요소 버전
	- 기타 고유 구분자
	- 의존관계
	- SBOM 데이터 소유자
	- 시간

### 보안 경계
- 보안 가드레일
- 규정 준수 가드레일
- 자원 제한 가드레일
- 인가 가드레일

## 파이프라인에서의(IN) 보안

![](images/Pasted%20image%2020230418162014.png)

### 코드 내의 민감/중요 식별
- CodeGuru Reviewer
- IDE 플러그인
- Pre-commit hook
- 리포지토리 스캐닝

### 소프트웨어 구성요소 분석(SCA)
- OWASP 디펜던시 추적기
- Anchore
- Snyk
- Mend

### 정적 어플리케이션 보안 점검(SAST)
- SonarQube
- Snyk
- Amazon CodeGuru
코드에 대한 점검을 수행한다.

### 동적 어플리케이션 보안 점검(DAST)
- OWASP ZAP
- Checkmarx
- Rapid7
배포되어 있는 애플리케이션을 대상으로 점검을 수행한다.

### 런타임 어플리케이션 자가 보호(RASP)
- Amazon GuardDuty
- Sysdig
- Falco
- Aqua

## 점검 및 분석
![](images/Pasted%20image%2020230418162752.png)

결국 이러한 단계들이 자동화되어야 한다.

## 배포 후 보안
### Detective Controls 
- Amazon GuardDuty
	- AWS의 관리형 위협 탐지 서비스
- AWS Inspector
	- EC2 Instance, ECR, Lambda 에 대한 취약점 점검
- AWS Config
	- AWS의 설정 관리 및 규정 준수 확인 서비스

### Incident Responce
- Amazon Detective
	- AWS의 관리형 위협 분석 서비스
- AWS Security Hub
	- AWS의 관리형 경보 통합 서비스

### Data Protection
- Amazon Macie
	- AWS의 관리형 민감정보 식별/탐지 서비스
		- AWS에 저장된 데이터(S3, 코드 등)를 정규표현식으로 식별하게 할 수 있다.
- AWS KMS
	- AWS의 암호화 키 관리 서비스

## Shift-left 보안 아키텍처
### 코드 작성 전 수행해야할 보안
개발팀에서 위협 모델링을 해야한다. 이는 개발 전 보안 요구 사항을 식별하는데 도움이 된다.

![](images/Pasted%20image%2020230418164210.png)

### 코드 작성 중 수행해야할 보안
IDE 확장 프로그램을 사용하여 보안 체크를 할 수 있다.

### Cloud Native를 위한 보안 도구들

### shift-left 보안 아키텍처

![](images/Pasted%20image%2020230418164540.png)


# 알아볼 부분
- 빠른 실패
- 코드 리뷰
- DevOps 문화
- Observability
- SAST 와 DAST 차이